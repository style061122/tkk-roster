<!DOCTYPE html>
<html>
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">

Â  Â  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
Â  Â  <meta http-equiv="Pragma" content="no-cache">
Â  Â  <meta http-equiv="Expires" content="0">

Â  Â  <title>é–€å¸‚æ’ç­ç®¡ç†ç³»çµ±</title>

Â  Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

Â  Â  <style>
Â  Â  Â  body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; }
Â  Â  Â  .main-container { max-width: 1400px; margin: 20px auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
Â  Â  Â  #loginSection { max-width: 400px; margin: 100px auto; text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
Â  Â  Â  .table th { vertical-align: middle; text-align: center; white-space: nowrap; font-size: 0.95rem; background-color: #343a40; color: white; }
Â  Â  Â  .table td { vertical-align: middle; padding: 8px 5px; font-size: 1rem; text-align: center; }
Â  Â  Â  input:read-only, select:disabled { background-color: #e9ecef; cursor: not-allowed; color: #6c757d; }
Â  Â  Â  .row-error { background-color: #ffe6e6 !important; }
Â  Â  Â  .row-warning { background-color: #fff3cd !important; }
Â  Â  Â  .msg-box { font-size: 0.85em; font-weight: bold; line-height: 1.3; display: block; min-height: 18px; }
Â  Â  Â  .text-err { color: #dc3545; } .text-warn { color: #856404; }
Â  Â  Â  #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
Â  Â  Â  .diff-pos { color: green; font-weight: bold; }Â 
Â  Â  Â  .diff-neg { color: red; font-weight: bold; }
Â  Â  Â  .view-btn.active { background-color: #0d6efd; color: white; border-color: #0d6efd; }
Â  Â  Â  .filter-group { display: flex; align-items: center; margin-right: 15px; }
Â  Â  Â  .custom-select-day { width: 100px !important; }
Â  Â  Â  .custom-select-name { width: 160px !important; }
Â  Â  Â  #liveSummaryBar { background-color: #fff3cd; border: 1px solid #ffecb5; border-radius: 8px; padding: 10px 15px; margin-bottom: 15px; display: none; font-size: 1rem; color: #664d03; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
Â  Â  Â  .swal2-container { z-index: 100000 !important; }
Â  Â  Â  .badge-abnormal { background-color: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }
Â  Â  Â  .badge-leave { background-color: #ffc107; color: black; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }
Â  Â  Â  #personalStats { background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; color: #495057; font-size: 1.1rem; }
Â  Â  </style>
</head>
Â  <body>
Â  Â  <div id="loadingOverlay"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div><h5 class="mt-3 text-dark fw-bold" id="loadingText">ç³»çµ±è¼‰å…¥ä¸­...</h5></div>
Â  Â Â 
Â  Â  <div id="loginSection" style="display:none;">
Â  Â  Â  <h3 class="mb-4 fw-bold text-primary">é ‚å‘±å‘±é–€å¸‚æ’ç­ç³»çµ±</h3>
Â  Â  Â  <div class="mb-3 text-start"><label class="form-label fw-bold">æ‰€å±¬å…¬å¸</label><select id="loginCompany" class="form-select form-select-lg" onchange="updateStoreOptions()"><option value="">è¼‰å…¥ä¸­...</option></select></div>
Â  Â  Â  <div class="mb-3 text-start"><label class="form-label fw-bold">é¸æ“‡é–€å¸‚</label><select id="loginStore" class="form-select form-select-lg"><option value="">è«‹å…ˆé¸æ“‡å…¬å¸</option></select></div>
Â  Â  Â  <div class="mb-4 text-start"><label class="form-label fw-bold">ç™»å…¥å¯†ç¢¼</label><input type="password" id="loginPassword" class="form-control form-select-lg" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"></div>
Â  Â  Â  <div class="d-grid"><button class="btn btn-primary btn-lg fw-bold shadow" onclick="handleLogin()">ç™»å…¥ç³»çµ±</button></div>
Â  Â  </div>

Â  Â  <div id="appSection" class="main-container" style="display:none;">
Â  Â  Â  <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3 flex-wrap gap-3">
Â  Â  Â  Â  <div><h2 class="fw-bold text-primary mb-1"><span id="displayStoreName"></span> æ’ç­è¡¨</h2><span class="badge bg-secondary fs-6" id="monthTargetInfo">è¼‰å…¥ä¸­...</span></div>
Â  Â  Â  Â  <div class="d-flex gap-2 align-items-center flex-wrap">
Â  Â  Â  Â  Â  Â <div class="d-flex align-items-center border rounded px-2 py-1 bg-light"><span id="displayYear" class="fw-bold fs-5 text-primary">2026</span><span class="mx-1">å¹´</span><span id="displayMonth" class="fw-bold fs-5 text-primary">1</span><span class="mx-1">æœˆ</span></div>
Â  Â  Â  Â  Â  Â <div class="btn-group"><button class="btn btn-outline-primary view-btn active" id="btnModeDate" onclick="switchMode('date')">ğŸ“… ä¾æ—¥æœŸæ’ç­</button><button class="btn btn-outline-primary view-btn" id="btnModeName" onclick="switchMode('name')">ğŸ‘¤ ä¾äººåæ’ç­</button></div>
Â  Â  Â  Â  Â  Â <div id="filterContainer" class="d-flex"><div id="filterDateGroup" class="filter-group"><label class="fw-bold mx-2">æ—¥ï¼š</label><select id="selectDay" class="form-select fw-bold border-primary custom-select-day" onchange="renderTable()"></select></div><div id="filterNameGroup" class="filter-group" style="display:none;"><label class="fw-bold mx-2">äººå“¡ï¼š</label><select id="selectName" class="form-select fw-bold border-primary custom-select-name" onchange="renderTable()"></select></div></div>
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â <button class="btn btn-info text-white fw-bold" onclick="showMonthlyStats()">ğŸ“Š æœˆçµ±è¨ˆ</button>
Â  Â  Â  Â  Â  Â <button class="btn btn-warning text-dark fw-bold" onclick="showIndividualStatus()">ğŸ‘¤ ç³»çµ±ç‹€æ…‹</button>
Â  Â  Â  Â  Â  Â <button class="btn btn-secondary fw-bold" onclick="handleChangePassword()">ğŸ”‘ å¯†ç¢¼è®Šæ›´</button>
Â  Â  Â  Â  Â  Â <button class="btn btn-success fw-bold" onclick="refreshData()">ğŸ”„ é‡æ–°æ•´ç†</button>
Â  Â  Â  Â  Â  Â <button class="btn btn-outline-danger fw-bold" onclick="logout()">ç™»å‡º</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <form id="scheduleForm">
Â  Â  Â  Â  <div class="table-responsive"><table class="table table-bordered table-hover align-middle"><thead><tr id="tableHeaderRow"><th style="width:12%">å§“å/æ—¥æœŸ</th><th style="width:15%">ç‹€æ…‹ (D)</th><th style="width:13%">ä¸Šç­ (E)</th><th style="width:13%">ä¸‹ç­ (F)</th><th style="width:10%">ä¼‘æ¯ (G)</th><th style="width:8%">æ™‚æ•¸ (H)</th><th style="width:29%">æª¢æ ¸è¨Šæ¯</th></tr></thead><tbody id="staffTable"></tbody></table></div>
Â  Â  Â  Â  <div id="liveSummaryBar"></div>
Â  Â  Â  Â  <div class="d-grid gap-2 mt-3"><button type="button" id="btnSave" class="btn btn-success btn-lg fw-bold shadow-sm" onclick="saveData(false)">ğŸ’¾ ç¢ºèªå„²å­˜ç­è¡¨</button></div>
Â  Â  Â  </form>
Â  Â  Â  <div id="closingNotice" class="text-center mt-2 text-secondary fw-bold" style="font-size: 0.9rem;"></div>
Â  Â  </div>

Â  Â  <div id="personalSection" class="container" style="display:none; max-width: 1400px; margin-top: 20px;">
Â  Â  Â  Â <h3 class="text-center fw-bold text-primary mb-2">ğŸ“… å€‹äººç­è¡¨èˆ‡å‡ºå‹¤ç´€éŒ„</h3>
Â  Â  Â  Â <h5 class="text-center text-secondary mb-4" id="personalNameDisplay">è¼‰å…¥ä¸­...</h5>
Â  Â  Â  Â <div id="personalStats"></div>
Â  Â  Â  Â <div class="table-responsive">
Â  Â  Â  Â  Â  Â <table class="table table-bordered table-hover table-striped">
Â  Â  Â  Â  Â  Â  Â  Â <thead><tr><th style="width: 8%">æ—¥æœŸ</th><th style="width: 8%">ç­è¡¨ç‹€æ…‹</th><th style="width: 10%">æ’ç­æ™‚é–“</th><th style="width: 6%">æ‡‰æœ‰æ™‚æ•¸<br>(H)</th><th style="width: 8%">ç³»çµ±ç‹€æ…‹<br>(I)</th><th style="width: 10%">å¯¦éš›æ‰“å¡<br>(ä¸Šç­/ä¸‹ç­)</th><th style="width: 10%">è«‹å‡æ™‚é–“<br>(L)</th><th style="width: 8%">å‡åˆ¥<br>(M)</th><th style="width: 10%">åŠ ç­æ™‚é–“<br>(N)</th><th style="width: 6%">åŠ ç­æ™‚æ•¸<br>(O)</th><th style="width: 10%">ç•°å¸¸<br>(P)</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â <tbody id="personalTableBody"></tbody>
Â  Â  Â  Â  Â  Â </table>
Â  Â  Â  Â </div>
Â  Â  Â  Â <div id="personalClosingNotice" class="text-center mt-3 text-secondary fw-bold" style="font-size: 0.9rem;"></div>
Â  Â  </div>

Â  Â  <div class="modal fade" id="statsModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-info text-white"><h5 class="modal-title fw-bold">ğŸ“Š æœ¬æœˆæ’ç­çµ±è¨ˆ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-light border d-flex justify-content-around fw-bold mb-3 text-dark bg-light" id="statsTarget"></div><h6 class="fw-bold text-primary border-bottom pb-2 mt-3">ğŸ”µ æœˆè–ªåˆ¶äººå“¡</h6><div class="table-responsive mb-4"><table class="table table-sm table-bordered text-center align-middle table-striped"><thead class="table-light"><tr><th>å§“å</th><th>æ‡‰æœ‰æ™‚æ•¸(å·®)</th><th>ä¼‘(å·®)</th><th>ä¾‹(å·®)</th><th>åœ‹å®š(å·®)</th><th>ç©ºç­</th></tr></thead><tbody id="statsTableMonthly"></tbody></table></div><h6 class="fw-bold text-success border-bottom pb-2">ğŸŸ¢ æ™‚è–ªåˆ¶äººå“¡</h6><div class="table-responsive"><table class="table table-sm table-bordered text-center align-middle table-striped"><thead class="table-light"><tr><th>å§“å</th><th>ç´¯è¨ˆæ‡‰æœ‰</th></tr></thead><tbody id="statsTableHourly"></tbody></table></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button></div></div></div></div>

Â  Â  <div class="modal fade" id="indivModal" tabindex="-1">
Â  Â  Â  <div class="modal-dialog modal-xl">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  <div class="modal-header bg-warning">
Â  Â  Â  Â  Â  Â  <h5 class="modal-title fw-bold text-dark">ğŸ‘¤ ç›®å‰ç³»çµ±ç‹€æ…‹ (æ•´æœˆæª¢è¦–)</h5>
Â  Â  Â  Â  Â  Â  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="modal-body">
Â  Â  Â  Â  Â  Â  <div class="mb-3 d-flex align-items-center flex-wrap gap-2">
Â  Â  Â  Â  Â  Â  Â  <label class="fw-bold">é¸æ“‡äººå“¡ï¼š</label>
Â  Â  Â  Â  Â  Â  Â  <select id="indivSelect" class="form-select w-auto" onchange="renderIndividualTable()"></select>
Â  Â  Â  Â  Â  Â  Â  <div id="indivStats" class="stat-info" style="flex-grow: 1;"></div>
Â  Â  Â  Â  Â  Â  Â  <span id="totalOvertimeDisplay" style="margin-left: auto; color: #dc3545; font-weight: bold; font-size: 1.2em;"></span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="qrCodeContainer" class="text-center mb-3 p-3 border rounded bg-light" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="fw-bold text-success mb-3">ğŸ“± è«‹å“¡å·¥ä½¿ç”¨æ‰‹æ©Ÿæƒæä¸‹æ–¹ QR Code</h6>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="qrCodeCanvas" class="d-flex justify-content-center align-items-center bg-white p-2 mx-auto border shadow-sm" style="width: 200px; height: 200px;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-secondary mt-3" onclick="document.getElementById('qrCodeContainer').style.display='none'">é—œé–‰ QRç¢¼</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="table-responsive">
Â  Â  Â  Â  Â  Â  Â  <table class="table table-sm table-striped table-bordered text-center" style="font-size: 0.9em;">
Â  Â  Â  Â  Â  Â  Â  Â  <thead class="table-dark"><tr><th>æ—¥æœŸ</th><th>ç­è¡¨(D)</th><th>æ’ç­æ™‚é–“</th><th>æ‡‰æœ‰(H)</th><th>ç³»çµ±ç‹€æ…‹(I)</th><th>ä¸Šç­å¡</th><th>ä¸‹ç­å¡</th><th>è«‹å‡</th><th>å‡åˆ¥</th><th>åŠ ç­</th><th>åŠ ç­æ™‚æ•¸</th><th>ç•°å¸¸</th><th>è¨»è¨˜(Q)</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="indivTableBody"></tbody>
Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  // â˜…â˜…â˜… è«‹å‹™å¿…ç¢ºèªé€™å€‹ç¶²å€æ˜¯æ‚¨æœ€æ–°çš„å¾Œç«¯ç¶²å€ â˜…â˜…â˜…
Â  Â  Â  const API_URL = "https://script.google.com/macros/s/AKfycbxaW0XoCauHhJKl2ag_kprlE-Rt8ymee-wGJcyO4YZkbJsMjaN5w6adOS9jUylRMP1q/exec";

Â  Â  Â  // å…¨åŸŸè®Šæ•¸
Â  Â  Â  let currentStore = "", currentData = [], monthlyTargets = { hrs:0, rest:0, reg:0, nat:0, holidays:[], weekStart: 1, customRules:[] };
Â  Â  Â  let currentParams = {}, currentMode = 'date', allStoreData = {};Â 
Â  Â  Â Â 
Â  Â  Â  // â˜… Token è®Šæ•¸ (é˜²å¤šé–‹é—œéµ)
Â  Â  Â  let currentToken = "";Â 

Â  Â  Â  const statusOpts = ["", "ä¸Šç­", "ä¼‘", "ä¾‹", "åœ‹", "ç©ºç­"];
Â  Â  Â  const timeOptions = generateTimeOptions(), restOptions = generateRestOptions();

Â  Â  Â  // ==========================================
Â  Â  Â  // â˜…â˜…â˜… é–’ç½®è‡ªå‹•ç™»å‡ºæ©Ÿåˆ¶ â˜…â˜…â˜…
Â  Â  Â  // ==========================================
Â  Â  Â  let idleTime = 0;
Â  Â  Â  const IDLE_LIMIT = 20; // 20 åˆ†é˜

Â  Â  Â  setInterval(() => {
Â  Â  Â  Â  Â  // åªæœ‰åœ¨ã€Œå·²ç™»å…¥ã€ä¸”ã€Œåœ¨æ“ä½œç•«é¢ã€æ‰è¨ˆæ™‚
Â  Â  Â  Â  Â  if (currentStore && document.getElementById('appSection').style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  idleTime++;
Â  Â  Â  Â  Â  Â  Â  if (idleTime >= IDLE_LIMIT) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Swal.fire({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon: 'warning',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: 'é–’ç½®éä¹…',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: 'ç‚ºä¿è­·è³‡æ–™å®‰å…¨ï¼Œç³»çµ±å·²è‡ªå‹•ç™»å‡ºã€‚è«‹é‡æ–°ç™»å…¥ã€‚',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  confirmButtonText: 'é‡æ–°ç™»å…¥',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowOutsideClick: false
Â  Â  Â  Â  Â  Â  Â  Â  Â  }).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logout();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  }, 60000);Â 

Â  Â  Â  function resetTimer() { idleTime = 0; }

Â  Â  Â  // ==========================================
Â  Â  Â  // window.onload (ç¨‹å¼å…¥å£)
Â  Â  Â  // ==========================================
Â  Â  Â  window.onload = function() {
Â  Â  Â  Â  // ç¶å®šé–’ç½®åµæ¸¬
Â  Â  Â  Â  document.onmousemove = resetTimer;
Â  Â  Â  Â  document.onkeypress = resetTimer;
Â  Â  Â  Â  document.ontouchstart = resetTimer;

Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  const mode = urlParams.get('mode');
Â  Â  Â  Â  Â  // â˜…â˜…â˜… ä¿®æ”¹é€™è¡Œï¼šå„ªå…ˆæŠ“å– 'key'ï¼Œå¦‚æœæ²’æœ‰æ‰æŠ“ 'u' (ç›¸å®¹èˆŠç‰ˆ) â˜…â˜…â˜…
Â  Â  Â  Â  const userParam = urlParams.get('key') || urlParams.get('u');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 1. å“¡å·¥å€‹äººé€£çµæ¨¡å¼
Â  Â  Â  Â  if (mode === 'personal' && userParam) {
Â  Â  Â  Â  Â  Â document.getElementById('loadingOverlay').style.display = 'flex';
Â  Â  Â  Â  Â  Â document.getElementById('loadingText').innerText = "è®€å–å€‹äººç­è¡¨ä¸­...";
Â  Â  Â  Â  Â  Â callApi('getPersonalData', { u: userParam })
Â  Â  Â  Â  Â  Â  Â .then(res => {
Â  Â  Â  Â  Â  Â  Â  Â  showLoading(false);
Â  Â  Â  Â  Â  Â  Â  Â  if (res.success) renderPersonalPage(res);
Â  Â  Â  Â  Â  Â  Â  Â  else document.body.innerHTML = `<div class="container text-center text-danger mt-5"><h3>âŒ ${res.message}</h3></div>`;
Â  Â  Â  Â  Â  Â  Â })
Â  Â  Â  Â  Â  Â  Â .catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  showLoading(false);
Â  Â  Â  Â  Â  Â  Â  Â  alert("éŒ¯èª¤ï¼š" + err.message);Â 
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  // 2. åº—é•·ç®¡ç†æ¨¡å¼
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â // â˜…â˜…â˜… SessionStorage æª¢æŸ¥ (é˜²F5ç™»å‡º) â˜…â˜…â˜…
Â  Â  Â  Â  Â  Â const savedStore = sessionStorage.getItem('tkk_store');
Â  Â  Â  Â  Â  Â const savedToken = sessionStorage.getItem('tkk_token');
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â if (savedStore && savedToken) {
Â  Â  Â  Â  Â  Â  Â  Â // è‡ªå‹•æ¢å¾©ç™»å…¥
Â  Â  Â  Â  Â  Â  Â  Â currentStore = savedStore;
Â  Â  Â  Â  Â  Â  Â  Â currentToken = savedToken;
Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('displayStoreName').innerText = savedStore;
Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('loginSection').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('appSection').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â // èƒŒæ™¯è¼‰å…¥é¸å–®
Â  Â  Â  Â  Â  Â  Â  Â callApi('getStoreList').then(res => { if(res.success) allStoreData = res.data; });
Â  Â  Â  Â  Â  Â  Â  Â loadData();Â 
Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â showLoading(true, "é€£ç·šä¸­...");
Â  Â  Â  Â  Â  Â  Â  Â callApi('getStoreList').then(res => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (res.success) initLogin(res.data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â else { showLoading(false); Swal.fire('éŒ¯èª¤', 'ç„¡æ³•å–å¾—é–€å¸‚æ¸…å–®', 'error'); }
Â  Â  Â  Â  Â  Â  Â  Â }).catch(err => errorHandler(err));
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  // ==========================================
Â  Â  Â  // åŠŸèƒ½å‡½å¼ (API / ç™»å…¥ / å­˜æª” / UI)
Â  Â  Â  // ==========================================
Â  Â  Â Â 
Â  Â  Â  function handleLogin() {
Â  Â  Â  Â  const store = document.getElementById('loginStore').value;
Â  Â  Â  Â  const pwd = document.getElementById('loginPassword').value;
Â  Â  Â  Â  if (!store || !pwd) { Swal.fire('éŒ¯èª¤', 'è«‹å¡«å¯«å®Œæ•´', 'error'); return; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  showLoading(true, "é©—è­‰ä¸­...");
Â  Â  Â  Â  callApi('login', { store: store, pwd: pwd }).then(res => {
Â  Â  Â  Â  Â  Â  Â showLoading(false);
Â  Â  Â  Â  Â  Â  Â if (res.success) {
Â  Â  Â  Â  Â  Â  Â  Â  currentStore = store;
Â  Â  Â  Â  Â  Â  Â  Â  currentToken = res.token; // â˜… å­˜ä¸‹ Token
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // â˜… å¯«å…¥ SessionStorage
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('tkk_store', store);
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('tkk_token', res.token);

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('displayStoreName').innerText = store;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginSection').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('appSection').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  loadData();
Â  Â  Â  Â  Â  Â  Â } else { Swal.fire('ç™»å…¥å¤±æ•—', res.message, 'error'); }
Â  Â  Â  Â  }).catch(err => errorHandler(err));
Â  Â  Â  }

Â  Â  Â  function logout() {Â 
Â  Â  Â  Â  currentStore = ""; currentData = []; currentToken = "";
Â  Â  Â  Â  sessionStorage.removeItem('tkk_store'); // â˜… æ¸…é™¤ Session
Â  Â  Â  Â  sessionStorage.removeItem('tkk_token');Â 
Â  Â  Â  Â  idleTime = 0;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('loginPassword').value = "";
Â  Â  Â  Â  document.getElementById('selectName').innerHTML = "";Â 
Â  Â  Â  Â  document.getElementById('selectDay').innerHTML = "";
Â  Â  Â  Â  document.getElementById('staffTable').innerHTML = "";
Â  Â  Â  Â  switchMode('date');Â 
Â  Â  Â  Â  document.getElementById('loginStore').innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å…¬å¸</option>';
Â  Â  Â  Â  document.getElementById('loginCompany').value = "";Â 
Â  Â  Â  Â  document.getElementById('appSection').style.display = 'none';
Â  Â  Â  Â  document.getElementById('loginSection').style.display = 'block';
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(Object.keys(allStoreData).length === 0) {
Â  Â  Â  Â  Â  Â  callApi('getStoreList').then(res => { if(res.success) initLogin(res.data); });
Â  Â  Â  Â  }
Â  Â  Â  Â  showLoading(false);
Â  Â  Â  }

Â  Â  Â  function refreshData() {
Â  Â  Â  Â  Â  loadData();
Â  Â  Â  Â  Â  const Toast = Swal.mixin({
Â  Â  Â  Â  Â  Â  toast: true,
Â  Â  Â  Â  Â  Â  position: 'top-end',
Â  Â  Â  Â  Â  Â  showConfirmButton: false,
Â  Â  Â  Â  Â  Â  timer: 1500,
Â  Â  Â  Â  Â  Â  timerProgressBar: true,
Â  Â  Â  Â  Â  Â  didOpen: (toast) => {
Â  Â  Â  Â  Â  Â  Â  toast.addEventListener('mouseenter', Swal.stopTimer)
Â  Â  Â  Â  Â  Â  Â  toast.addEventListener('mouseleave', Swal.resumeTimer)
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Toast.fire({ icon: 'success', title: 'è³‡æ–™å·²æ›´æ–°' });
Â  Â  Â  }

Â  Â  Â  function saveData(force) {
Â  Â  Â  Â  // ==========================================
Â  Â  Â  Â  // â˜…â˜…â˜… æ–°å¢ï¼šé—œå¸³æ—¥é–å®šæ©Ÿåˆ¶ (å‰ç«¯é˜²å‘† - å€é–“é¡¯ç¤ºç‰ˆ) â˜…â˜…â˜…
Â  Â  Â  Â  // ==========================================
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  let limitDay = parseInt(monthlyTargets.closingDay) || 4;
Â  Â  Â  Â  Â  Â  let now = new Date();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 1. è¨­å®šé—œå¸³åŸºæº–é» (æœ¬æœˆ Xè™Ÿ 09:00)
Â  Â  Â  Â  Â  Â  let closingDeadline = new Date();
Â  Â  Â  Â  Â  Â  closingDeadline.setDate(limitDay);
Â  Â  Â  Â  Â  Â  closingDeadline.setHours(9, 0, 0, 0);

Â  Â  Â  Â  Â  Â  // 2. è¨­å®šé–å®šé–‹å§‹æ™‚é–“ (åœ¨æ­¤ä¿®æ”¹å°æ™‚æ•¸)
Â  Â  Â  Â  Â  Â  let lockoutStart = new Date(closingDeadline);
Â  Â  Â  Â  Â  Â  // â˜…â˜…â˜… è¨­å®šå€ï¼šé€™è£¡è¼¸å…¥ -24, -30, -48 çš†å¯ â˜…â˜…â˜…
Â  Â  Â  Â  Â  Â  lockoutStart.setHours(closingDeadline.getHours() - 24);Â 

Â  Â  Â  Â  Â  Â  // 3. åˆ¤æ–·æ˜¯å¦åœ¨é–å®šå€é–“å…§
Â  Â  Â  Â  Â  Â  if (now >= lockoutStart && now < closingDeadline) {
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 4. å®šç¾©æ—¥æœŸæ ¼å¼åŒ–å·¥å…· (è½‰æˆ "2æœˆ3æ—¥ 09:00" æ ¼å¼)
Â  Â  Â  Â  Â  Â  Â  Â  const fmt = (d) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let m = d.getMonth() + 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let dd = d.getDate();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let hh = String(d.getHours()).padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `${m}æœˆ${dd}æ—¥ ${hh}:00`;
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  let startStr = fmt(lockoutStart);Â  Â // è‡ªå‹•ç®—å‡ºèµ·å§‹å­—ä¸²
Â  Â  Â  Â  Â  Â  Â  Â  let endStr = fmt(closingDeadline);Â  // è‡ªå‹•ç®—å‡ºçµæŸå­—ä¸²
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Swal.fire({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon: 'error',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: 'â›” ç³»çµ±é—œå¸³é–å®šä¸­',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html: `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: left; font-size: 0.95rem; line-height: 1.6;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  å› æ‡‰è–ªè³‡çµç®—ä½œæ¥­ï¼Œç›®å‰è™•æ–¼è³‡æ–™å°å­˜æœŸï¼Œ<strong>ç„¡æ³•èª¿æ•´ç­è¡¨</strong>ã€‚<br><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ”’ <strong>é–å®šæ™‚é–“ï¼š</strong> ${startStr} èµ·è‡³ ${endStr}<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“… <strong>é è¨ˆé–‹æ”¾æ™‚é–“ï¼š</strong> ${endStr}<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-muted" style="font-size:0.85rem;">(ç³»çµ±å°‡æ–¼çµç®—å¾Œè‡ªå‹•ç”¢ç”Ÿéš”æœˆç­è¡¨)</span><br><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: #d63384;">âš ï¸ è‹¥æœ‰ç·Šæ€¥ä¿®æ­£éœ€æ±‚ï¼Œè«‹ç§è¨Š <strong>äººè³‡å®˜æ–¹å¸³è™Ÿ</strong>ã€‚</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  confirmButtonText: 'äº†è§£',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowOutsideClick: false
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return; // æ“‹ä½ï¼
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("æ—¥æœŸæª¢æŸ¥éŒ¯èª¤", e);
Â  Â  Â  Â  }
Â  Â  Â  Â  // ==========================================
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  const rows = document.querySelectorAll('#staffTable tr');Â 
Â  Â  Â  Â  let inputData = [];Â 
Â  Â  Â  Â  let incomplete = false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  rows.forEach(tr => {
Â  Â  Â  Â  Â  const idx = parseInt(tr.getAttribute('data-index'));Â 
Â  Â  Â  Â  Â  const s = tr.querySelector('.status-select').value;Â 
Â  Â  Â  Â  Â  const verifyName = tr.getAttribute('data-name');Â 
Â  Â  Â  Â  Â  const verifyDate = tr.getAttribute('data-date');
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (s === 'ä¸Šç­') {
Â  Â  Â  Â  Â  Â  const start = tr.querySelector('.start-select').value;Â 
Â  Â  Â  Â  Â  Â  const end = tr.querySelector('.end-select').value;Â 
Â  Â  Â  Â  Â  Â  const rest = tr.querySelector('.rest-select').value;
Â  Â  Â  Â  Â  Â  if (!start || !end || rest === "") { incomplete = true; tr.classList.add('row-error'); }
Â  Â  Â  Â  Â  Â  inputData.push({ rowIndex: idx, verifyName: verifyName, verifyDate: verifyDate, d: s, e: start, f: end, g: rest });
Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  inputData.push({ rowIndex: idx, verifyName: verifyName, verifyDate: verifyDate, d: s, e: "", f: "", g: "" });Â 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (incomplete) { Swal.fire('éŒ¯èª¤', 'ä¸Šç­éœ€å¡«å¯«å®Œæ•´æ™‚é–“', 'warning'); return; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  showLoading(true, "å„²å­˜ä¸­...");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // â˜… å‘¼å«å¾Œç«¯æ™‚å¸¶ä¸Š Token
Â  Â  Â  Â  callApi('saveStoreData', {Â 
Â  Â  Â  Â  Â  Â  store: currentStore,Â 
Â  Â  Â  Â  Â  Â  inputData: inputData,Â 
Â  Â  Â  Â  Â  Â  forceSave: force,
Â  Â  Â  Â  Â  Â  token: currentTokenÂ 
Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .then(res => {
Â  Â  Â  Â  Â  Â  Â showLoading(false);Â 
Â  Â  Â  Â  Â  Â  Â if (res.status === 'SUCCESS') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â Swal.fire({ icon: 'success', title: 'âœ… å„²å­˜æˆåŠŸ', text: 'ç­è¡¨å·²æ›´æ–°å®Œæˆ', confirmButtonText: 'ç¢ºèª', allowOutsideClick: false }).then((result) => { if (result.isConfirmed) loadData(); });Â 
Â  Â  Â  Â  Â  Â  Â }Â 
Â  Â  Â  Â  Â  Â  Â else if (res.status === 'FAILED' && res.message.includes("å¼·åˆ¶ç™»å‡º")) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â // â˜… æ¶æ——å¤±æ•—ï¼Œè¢«å¼·åˆ¶ç™»å‡º
Â  Â  Â  Â  Â  Â  Â  Â  Â Swal.fire({ icon: 'error', title: 'âŒ é©—è­‰å¤±æ•—', html: res.message, confirmButtonText: 'ç¢ºå®š', allowOutsideClick: false }).then(() => logout());Â 
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â else if (res.status === 'PARTIAL') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â Swal.fire({ icon: 'warning', title: 'âš ï¸ éƒ¨åˆ†å„²å­˜æˆåŠŸ', html: `<div style="text-align:left; font-size:0.9rem;">${res.message}</div>`, confirmButtonText: 'ç¢ºèª' }).then(() => loadData());Â 
Â  Â  Â  Â  Â  Â  Â }Â 
Â  Â  Â  Â  Â  Â  Â else if (res.status === 'FAILED') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â Swal.fire({ icon: 'error', title: 'âŒ å„²å­˜å¤±æ•—', html: `<div style="text-align:left; font-size:0.9rem;">${res.message}</div>`, confirmButtonText: 'ç¢ºèª' }).then(() => loadData());Â 
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â Swal.fire('ç³»çµ±è¨Šæ¯', res.message || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤', 'error').then(() => loadData());Â 
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .catch(err => {Â 
Â  Â  Â  Â  Â  Â  Â showLoading(false);Â 
Â  Â  Â  Â  Â  Â  Â alert("å„²å­˜éŒ¯èª¤: " + err.message);Â 
Â  Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  function callApi(op, params = {}) {
Â  Â  Â  Â  Â params.op = op;
Â  Â  Â  Â  Â return fetch(API_URL, {
Â  Â  Â  Â  Â  Â  Â method: 'POST',
Â  Â  Â  Â  Â  Â  Â headers: { 'Content-Type': 'text/plain;charset=utf-8' },
Â  Â  Â  Â  Â  Â  Â body: JSON.stringify(params)
Â  Â  Â  Â  Â }).then(response => {
Â  Â  Â  Â  Â  Â  Â return response.text().then(text => {
Â  Â  Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return JSON.parse(text);
Â  Â  Â  Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("API Error Raw:", text);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error("å¾Œç«¯å›æ‡‰é JSON æ ¼å¼");
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â });
Â  Â  Â  }

Â  Â  Â  function initLogin(data) {
Â  Â  Â  Â  showLoading(false); allStoreData = data || {};Â 
Â  Â  Â  Â  const coSelect = document.getElementById('loginCompany');
Â  Â  Â  Â  coSelect.innerHTML = '<option value="">è«‹é¸æ“‡å…¬å¸</option>';
Â  Â  Â  Â  Object.keys(allStoreData).forEach(co => { coSelect.innerHTML += `<option value="${co}">${co}</option>`; });
Â  Â  Â  Â  document.getElementById('loginSection').style.display = 'block';
Â  Â  Â  }

Â  Â  Â  function updateStoreOptions() {
Â  Â  Â  Â  const company = document.getElementById('loginCompany').value;
Â  Â  Â  Â  const storeSelect = document.getElementById('loginStore');
Â  Â  Â  Â  storeSelect.innerHTML = '<option value="">è«‹é¸æ“‡é–€å¸‚</option>';
Â  Â  Â  Â  if (company && allStoreData[company]) {
Â  Â  Â  Â  Â  Â  allStoreData[company].forEach(store => { storeSelect.innerHTML += `<option value="${store}">${store}</option>`; });
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  function loadData() {
Â  Â  Â  Â  if (!currentStore) return;
Â  Â  Â  Â  showLoading(true, "è®€å–è³‡æ–™ä¸­...");
Â  Â  Â  Â  callApi('getStoreData', { store: currentStore }).then(res => {
Â  Â  Â  Â  Â  Â  Â showLoading(false);
Â  Â  Â  Â  Â  Â  Â if (res.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â currentData = res.data || [];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â monthlyTargets = res.targets || {};Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â currentParams = res.params || {};
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â const year = monthlyTargets.year || new Date().getFullYear();
Â  Â  Â  Â  Â  Â  Â  Â  Â const month = monthlyTargets.month || (new Date().getMonth()+1);
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('displayYear').innerText = year;
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('displayMonth').innerText = month;
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('monthTargetInfo').innerText = `ç›®æ¨™: æ‡‰æœ‰${monthlyTargets.hrs} | ä¼‘${monthlyTargets.rest} | ä¾‹${monthlyTargets.reg} | åœ‹${monthlyTargets.nat}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â let nextMonth = (parseInt(month) % 12) + 1;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â let closeDay = monthlyTargets.closingDay || 1;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â let noticeText = `ğŸ“… ç³»çµ±å°‡æ–¼ ${nextMonth}æœˆ${closeDay}æ—¥ 09:00 é€²è¡Œè–ªè³‡çµç®—ï¼Œå±†æ™‚å°‡è‡ªå‹•é‡ç½®ä¸¦ç”¢ç”Ÿéš”æœˆæ’ç­è³‡æ–™ã€‚`;
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('closingNotice').innerText = noticeText;

Â  Â  Â  Â  Â  Â  Â  Â  Â if(document.getElementById('selectDay').options.length === 0) initDaySelect(year, month);
Â  Â  Â  Â  Â  Â  Â  Â  Â initNameSelect(); renderTable();
Â  Â  Â  Â  Â  Â  Â } else { Swal.fire('éŒ¯èª¤', 'è³‡æ–™è®€å–å¤±æ•—', 'error'); }
Â  Â  Â  Â  }).catch(err => errorHandler(err));
Â  Â  Â  }

Â  Â  Â  function initDaySelect(year, month) {
Â  Â  Â  Â  const select = document.getElementById('selectDay'); select.innerHTML = '';
Â  Â  Â  Â  const daysInMonth = new Date(year, month, 0).getDate(); const today = new Date().getDate();
Â  Â  Â  Â  for(let d=1; d<=daysInMonth; d++) { let selected = (d === today) ? "selected" : ""; select.innerHTML += `<option value="${d}" ${selected}>${d} æ—¥</option>`; }
Â  Â  Â  }

Â  Â  Â  function initNameSelect() {
Â  Â  Â  Â  const select = document.getElementById('selectName'); select.innerHTML = '';
Â  Â  Â  Â  const names = [...new Set(currentData.map(r => r.name))];
Â  Â  Â  Â  names.forEach(n => select.innerHTML += `<option value="${n}">${n}</option>`);
Â  Â  Â  }

Â  Â  Â  function switchMode(mode) {
Â  Â  Â  Â  currentMode = mode;
Â  Â  Â  Â  document.getElementById('btnModeDate').classList.toggle('active', mode === 'date');
Â  Â  Â  Â  document.getElementById('btnModeName').classList.toggle('active', mode === 'name');
Â  Â  Â  Â  document.getElementById('filterDateGroup').style.display = (mode === 'date') ? 'flex' : 'none';
Â  Â  Â  Â  document.getElementById('filterNameGroup').style.display = (mode === 'name') ? 'flex' : 'none';
Â  Â  Â  Â  document.getElementById('tableHeaderRow').cells[0].innerText = (mode === 'date') ? "å§“å" : "æ—¥æœŸ";
Â  Â  Â  Â  renderTable();
Â  Â  Â  }

Â  Â  Â  function getWeeklyUsage(name, dateStr) {
Â  Â  Â  Â  Â let currDate = new Date(dateStr);
Â  Â  Â  Â  Â let startDayParam = monthlyTargets.weekStart || 1;Â 
Â  Â  Â  Â  Â let day = currDate.getDay();Â 
Â  Â  Â  Â  Â let adjDay = (day === 0 ? 7 : day) - startDayParam; if (adjDay < 0) adjDay += 7;
Â  Â  Â  Â  Â let weekStart = new Date(currDate); weekStart.setDate(currDate.getDate() - adjDay);
Â  Â  Â  Â  Â let weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 6);
Â  Â  Â  Â  Â let personData = currentData.filter(r => r.name === name).map(r => ({...r}));
Â  Â  Â  Â  Â if (currentMode === 'name') {
Â  Â  Â  Â  Â  Â  Â const rows = document.querySelectorAll('#staffTable tr');
Â  Â  Â  Â  Â  Â  Â rows.forEach(tr => {
Â  Â  Â  Â  Â  Â  Â  Â  Â let d = tr.getAttribute('data-date'); let s = tr.querySelector('.status-select').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â let t = personData.find(x => x.date === d); if (t) t.input_status = s;Â 
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â let weekData = personData.filter(r => { let d = new Date(r.date); return d >= weekStart && d <= weekEnd; });
Â  Â  Â  Â  Â let usage = { rest: 0, reg: 0 };
Â  Â  Â  Â  Â weekData.forEach(r => { if (r.input_status === 'ä¼‘') usage.rest++; if (r.input_status === 'ä¾‹') usage.reg++; });
Â  Â  Â  Â  Â return usage;
Â  Â  Â  }

Â  Â  Â  function getRangeUsage(name, type, startDay, endDay) {
Â  Â  Â  Â  Â let personData = currentData.filter(r => r.name === name).map(r => ({...r}));
Â  Â  Â  Â  Â if (currentMode === 'name') {
Â  Â  Â  Â  Â  Â  Â const rows = document.querySelectorAll('#staffTable tr');
Â  Â  Â  Â  Â  Â  Â rows.forEach(tr => {
Â  Â  Â  Â  Â  Â  Â  Â  Â let d = tr.getAttribute('data-date'); let s = tr.querySelector('.status-select').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â let t = personData.find(x => x.date === d); if (t) t.input_status = s;Â 
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â let count = 0;
Â  Â  Â  Â  Â personData.forEach(r => { let d = parseInt(r.date.split('/')[2]); if (d >= startDay && d <= endDay && r.input_status === type) count++; });
Â  Â  Â  Â  Â return count;
Â  Â  Â  }

Â  Â  Â  function renderTable() {
Â  Â  Â  Â  const tbody = document.getElementById('staffTable'); tbody.innerHTML = '';
Â  Â  Â  Â  const summaryBar = document.getElementById('liveSummaryBar'); summaryBar.style.display = 'none';Â 
Â  Â  Â  Â  const y = document.getElementById('displayYear').innerText; const m = document.getElementById('displayMonth').innerText.padStart(2, '0');
Â  Â  Â  Â  let targetData = [], targetName = "";
Â  Â  Â  Â  if (currentMode === 'date') {
Â  Â  Â  Â  Â  Â const d = document.getElementById('selectDay').value.padStart(2, '0'); const targetDateStr = `${y}/${m}/${d}`;
Â  Â  Â  Â  Â  Â targetData = currentData.filter(row => row.date === targetDateStr);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â targetName = document.getElementById('selectName').value; targetData = currentData.filter(row => row.name === targetName);
Â  Â  Â  Â  Â  Â targetData.sort((a,b) => a.date.localeCompare(b.date)); summaryBar.style.display = 'block';Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  if (targetData.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted fw-bold">ç„¡è³‡æ–™</td></tr>'; if(currentMode === 'name') updateLiveSummary(targetName); return; }
Â  Â  Â  Â  targetData.forEach((row) => {
Â  Â  Â  Â  Â  let originalIndex = currentData.indexOf(row);
Â  Â  Â  Â  Â  let tr = document.createElement('tr');
Â  Â  Â  Â  Â  tr.setAttribute('data-index', originalIndex); tr.setAttribute('data-salary', row.salaryType); tr.setAttribute('data-name', row.name); tr.setAttribute('data-date', row.date);
Â  Â  Â  Â  Â  let col1Content = (currentMode === 'date') ? `<div class="fw-bold fs-5">${row.name}</div><span class="badge bg-${row.salaryType.includes("æœˆè–ª") ? "primary" : "success"} rounded-pill">${row.salaryType}</span>` : `<div class="fw-bold fs-5">${row.date.split('/')[2]} æ—¥ <small class="text-muted fs-6">(${new Date(row.date).toLocaleDateString('zh-TW', {weekday: 'short'})})</small></div><span class="badge bg-${row.salaryType.includes("æœˆè–ª") ? "primary" : "success"} rounded-pill">${row.salaryType}</span>`;
Â  Â  Â  Â  Â  tr.innerHTML += `<td>${col1Content}</td>`;
Â  Â  Â  Â  Â  let statusHtml = `<select class="form-select status-select fw-bold border-dark" onchange="handleRowChange(this)">`;
Â  Â  Â  Â  Â  let currentDay = parseInt(row.date.split('/')[2]);
Â  Â  Â  Â  Â  let isHourlyHoliday = (monthlyTargets.holidays || []).includes(currentDay.toString());
Â  Â  Â  Â  Â  let allowed = [];
Â  Â  Â  Â  Â  if (row.salaryType.includes("æ™‚è–ª")) {
Â  Â  Â  Â  Â  Â  Â let usage = getWeeklyUsage(row.name, row.date);
Â  Â  Â  Â  Â  Â  Â if (isHourlyHoliday) allowed = ["", "ä¸Šç­", "åœ‹"];
Â  Â  Â  Â  Â  Â  Â else { allowed = ["", "ä¸Šç­", "ç©ºç­"]; if (usage.rest < 1 || row.input_status === 'ä¼‘') allowed.push("ä¼‘"); if (usage.reg < 1 || row.input_status === 'ä¾‹') allowed.push("ä¾‹"); }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â let activeRules = (monthlyTargets.customRules || []).filter(r => currentDay >= r.start && currentDay <= r.end);
Â  Â  Â  Â  Â  Â  Â if (activeRules.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â allowed = ["", "ç©ºç­"]; let hasWorkRule = activeRules.some(r => r.type === 'ä¸Šç­'); if (!hasWorkRule) allowed.push("ä¸Šç­");
Â  Â  Â  Â  Â  Â  Â  Â  Â activeRules.forEach(r => { let used = getRangeUsage(row.name, r.type, r.start, r.end); if (used < r.limit || row.input_status === r.type) { if (!allowed.includes(r.type)) allowed.push(r.type); } });
Â  Â  Â  Â  Â  Â  Â } else { allowed = statusOpts; }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (row.input_status && !allowed.includes(row.input_status)) allowed.push(row.input_status);
Â  Â  Â  Â  Â  statusOpts.forEach(opt => { if (allowed.includes(opt)) { let selected = (row.input_status === opt) ? "selected" : ""; statusHtml += `<option value="${opt}" ${selected}>${opt || "è«‹é¸æ“‡"}</option>`; } });
Â  Â  Â  Â  Â  statusHtml += `</select>`;
Â  Â  Â  Â  Â  tr.innerHTML += `<td>${statusHtml}</td>`;
Â  Â  Â  Â  Â  tr.innerHTML += `<td>${createTimeSelect(row.input_start, 'start-select')}</td><td>${createTimeSelect(row.input_end, 'end-select')}</td><td>${createRestSelect(row.input_rest)}</td><td><input type="text" class="form-control text-center fw-bold hours-input border-0 bg-transparent" value="${row.calc_hours}" readonly></td><td><div class="msg-box"></div></td>`;
Â  Â  Â  Â  Â  tbody.appendChild(tr); updateRowState(tr); validateRow(tr);Â  Â Â 
Â  Â  Â  Â  });
Â  Â  Â  Â  if (currentMode === 'name') updateLiveSummary(targetName);
Â  Â  Â  }

Â  Â  Â  function handleRowChange(element) {
Â  Â  Â  Â  let tr = element.closest('tr'); let idx = parseInt(tr.getAttribute('data-index'));
Â  Â  Â  Â  currentData[idx].input_status = tr.querySelector('.status-select').value;
Â  Â  Â  Â  currentData[idx].input_start = tr.querySelector('.start-select').value;
Â  Â  Â  Â  currentData[idx].input_end = tr.querySelector('.end-select').value;
Â  Â  Â  Â  currentData[idx].input_rest = tr.querySelector('.rest-select').value;
Â  Â  Â  Â  updateRowState(tr); calculateRow(tr); currentData[idx].calc_hours = tr.querySelector('.hours-input').value;
Â  Â  Â  Â  if (currentMode === 'name') { let salary = tr.getAttribute('data-salary'); let name = tr.getAttribute('data-name'); if (salary.includes("æ™‚è–ª")) refreshHourlyDropdowns(name); else if (salary.includes("æœˆè–ª")) refreshMonthlyDropdowns(name); updateLiveSummary(name); }
Â  Â  Â  Â  validateRow(tr); checkRealTimeBudget(tr); validateAll();
Â  Â  Â  }

Â  Â  Â  function refreshHourlyDropdowns(name) {
Â  Â  Â  Â  Â const rows = document.querySelectorAll('#staffTable tr');
Â  Â  Â  Â  Â rows.forEach(tr => {
Â  Â  Â  Â  Â  Â  Â if (tr.getAttribute('data-name') !== name) return;
Â  Â  Â  Â  Â  Â  Â const dateStr = tr.getAttribute('data-date'); const select = tr.querySelector('.status-select'); const currentVal = select.value;
Â  Â  Â  Â  Â  Â  Â let usage = getWeeklyUsage(name, dateStr); let currentDay = parseInt(dateStr.split('/')[2]).toString();
Â  Â  Â  Â  Â  Â  Â let isHourlyHoliday = (monthlyTargets.holidays || []).includes(currentDay);
Â  Â  Â  Â  Â  Â  Â let allowed = [];
Â  Â  Â  Â  Â  Â  Â if (isHourlyHoliday) allowed = ["", "ä¸Šç­", "åœ‹"]; else { allowed = ["", "ä¸Šç­", "ç©ºç­"]; if (usage.rest < 1 || currentVal === 'ä¼‘') allowed.push("ä¼‘"); if (usage.reg < 1 || currentVal === 'ä¾‹') allowed.push("ä¾‹"); }
Â  Â  Â  Â  Â  Â  Â if (currentVal && !allowed.includes(currentVal)) allowed.push(currentVal);
Â  Â  Â  Â  Â  Â  Â let newHtml = ""; statusOpts.forEach(opt => { if (allowed.includes(opt)) { let selected = (currentVal === opt) ? "selected" : ""; newHtml += `<option value="${opt}" ${selected}>${opt || "è«‹é¸æ“‡"}</option>`; } });
Â  Â  Â  Â  Â  Â  Â if (select.innerHTML !== newHtml) { select.innerHTML = newHtml; select.value = currentVal; }
Â  Â  Â  Â  Â });
Â  Â  Â  }

Â  Â  Â  function refreshMonthlyDropdowns(name) {
Â  Â  Â  Â  Â const rows = document.querySelectorAll('#staffTable tr');
Â  Â  Â  Â  Â rows.forEach(tr => {
Â  Â  Â  Â  Â  Â  Â if (tr.getAttribute('data-name') !== name) return;
Â  Â  Â  Â  Â  Â  Â const dateStr = tr.getAttribute('data-date'); const select = tr.querySelector('.status-select'); const currentVal = select.value;
Â  Â  Â  Â  Â  Â  Â const currentDay = parseInt(dateStr.split('/')[2]);
Â  Â  Â  Â  Â  Â  Â let activeRules = (monthlyTargets.customRules || []).filter(r => currentDay >= r.start && currentDay <= r.end);
Â  Â  Â  Â  Â  Â  Â let allowed = [];
Â  Â  Â  Â  Â  Â  Â if (activeRules.length > 0) { allowed = ["", "ç©ºç­"]; let hasWorkRule = activeRules.some(r => r.type === 'ä¸Šç­'); if (!hasWorkRule) allowed.push("ä¸Šç­"); activeRules.forEach(r => { let used = getRangeUsage(name, r.type, r.start, r.end); if (used < r.limit || currentVal === r.type) { if (!allowed.includes(r.type)) allowed.push(r.type); } }); } else { allowed = statusOpts; }
Â  Â  Â  Â  Â  Â  Â if (currentVal && !allowed.includes(currentVal)) allowed.push(currentVal);
Â  Â  Â  Â  Â  Â  Â let newHtml = ""; statusOpts.forEach(opt => { if (allowed.includes(opt)) { let selected = (currentVal === opt) ? "selected" : ""; newHtml += `<option value="${opt}" ${selected}>${opt || "è«‹é¸æ“‡"}</option>`; } });
Â  Â  Â  Â  Â  Â  Â if (select.innerHTML !== newHtml) { select.innerHTML = newHtml; select.value = currentVal; }
Â  Â  Â  Â  Â });
Â  Â  Â  }

Â  Â  Â  function updateLiveSummary(name) {
Â  Â  Â  Â  Â if (!name) return;
Â  Â  Â  Â  Â let pData = currentData.filter(r => r.name === name);
Â  Â  Â  Â  Â let hrs = 0, rest = 0, reg = 0, nat = 0, empty = 0;
Â  Â  Â  Â  Â pData.forEach(r => { let h = parseFloat(r.calc_hours); if(!isNaN(h)) hrs += h; if (r.input_status === 'ä¼‘') rest++; else if (r.input_status === 'ä¾‹') reg++; else if (r.input_status === 'åœ‹') nat++; else if (r.input_status === 'ç©ºç­') empty++; });
Â  Â  Â  Â  Â const bar = document.getElementById('liveSummaryBar');
Â  Â  Â  Â  Â bar.innerHTML = `<span class="me-3">ç›®å‰ç´¯è¨ˆ (${name})ï¼š</span> æ‡‰æœ‰ <span class="${getDiffClass(hrs, monthlyTargets.hrs)}">${hrs.toFixed(1)}</span> / ä¼‘ <span class="${getDiffClass(rest, monthlyTargets.rest)}">${rest}</span> / ä¾‹ <span class="${getDiffClass(reg, monthlyTargets.reg)}">${reg}</span> / åœ‹ <span class="${getDiffClass(nat, monthlyTargets.nat)}">${nat}</span> / ç©ºç­ ${empty}`;
Â  Â  Â  }

Â  Â  Â  function getDiffClass(val, target) { if (val > target) return 'text-danger'; if (val < target) return 'text-primary'; return 'text-success'; }
Â  Â  Â  function updateRowState(tr) {
Â  Â  Â  Â  const status = tr.querySelector('.status-select').value; const inputs = tr.querySelectorAll('.time-select, .rest-select'); const hInput = tr.querySelector('.hours-input');
Â  Â  Â  Â  if (status === 'ä¸Šç­') { inputs.forEach(el => { el.disabled = false; el.classList.remove('bg-light'); }); } else { inputs.forEach(el => { el.disabled = true; el.classList.add('bg-light'); el.value = ""; }); hInput.value = ""; tr.querySelector('.msg-box').innerHTML = ""; tr.classList.remove('row-error', 'row-warning'); }
Â  Â  Â  }
Â  Â  Â  function calculateRow(tr) {
Â  Â  Â  Â  const status = tr.querySelector('.status-select').value; if (status !== 'ä¸Šç­') return;
Â  Â  Â  Â  const s = tr.querySelector('.start-select').value; const e = tr.querySelector('.end-select').value; const r = tr.querySelector('.rest-select').value; const hInput = tr.querySelector('.hours-input');
Â  Â  Â  Â  if (s && e && r !== "") { let start = timeToFloat(s), end = timeToFloat(e), rest = parseFloat(r); if (end < start) end += 24; let total = end - start - rest; hInput.value = (total > 0) ? total.toFixed(1) : "0.0"; } else { hInput.value = ""; }
Â  Â  Â  }
Â  Â  Â  function validateRow(tr) {
Â  Â  Â  Â  const status = tr.querySelector('.status-select').value; const msgBox = tr.querySelector('.msg-box'); const salaryType = tr.getAttribute('data-salary'); const dateStr = tr.getAttribute('data-date');Â 
Â  Â  Â  Â  const hVal = parseFloat(tr.querySelector('.hours-input').value) || 0; const rVal = parseFloat(tr.querySelector('.rest-select').value) || 0;
Â  Â  Â  Â  msgBox.innerHTML = ""; tr.classList.remove('row-error', 'row-warning'); let errors = [], warnings = [];
Â  Â  Â  Â  let currentDay = parseInt(dateStr.split('/')[2]).toString(); let isHourlyHoliday = (monthlyTargets.holidays || []).includes(currentDay);
Â  Â  Â  Â  if (salaryType.includes("æ™‚è–ª") && isHourlyHoliday && status === "åœ‹") warnings.push("âš ï¸ æ™‚è–ªäººå“¡å¦‚æœ‰å‡ºå‹¤ï¼Œç‹€æ…‹è«‹æ”¹ç‚º'ä¸Šç­'");
Â  Â  Â  Â  if (salaryType.includes("æœˆè–ª") && status === "åœ‹") warnings.push("âš ï¸ æœˆè–ªäººå“¡å¦‚æœ‰å‡ºå‹¤ï¼Œè«‹æ•´å¤©ç”³è«‹åŠ ç­å–®");
Â  Â  Â  Â  if (salaryType.includes("æœˆè–ª") && status === "ç©ºç­") warnings.push("âš ï¸ ç•¶æœˆæ‡‰æœ‰æ™‚æ•¸å¤§æ–¼8æ‰æœƒç”¢ç”Ÿç©ºç­");
Â  Â  Â  Â  if (status === 'ä¸Šç­' && tr.querySelector('.start-select').value) { if (salaryType.includes("æœˆè–ª") && hVal > 10) errors.push("âŒ æœˆè–ªåˆ¶ä¸å¯>10å°æ™‚"); else if (salaryType.includes("æ™‚è–ª") && hVal > 8) errors.push("âŒ æ™‚è–ªåˆ¶ä¸å¯>8å°æ™‚"); if (hVal > 8 && rVal < 1) errors.push("âŒ >8å°æ™‚éœ€ä¼‘1å°æ™‚"); else if (hVal > 4 && rVal < 0.5) errors.push("âŒ >4å°æ™‚éœ€ä¼‘0.5å°æ™‚"); }
Â  Â  Â  Â  if (errors.length > 0) { msgBox.innerHTML = errors.map(e=>`<span class="text-err">${e}</span>`).join("<br>"); tr.classList.add('row-error'); } else if (warnings.length > 0) { msgBox.innerHTML = warnings.map(w=>`<span class="text-warn">${w}</span>`).join("<br>"); tr.classList.add('row-warning'); }
Â  Â  Â  }
Â  Â  Â  function checkRealTimeBudget(tr) {
Â  Â  Â  Â  if (!currentData.length) return; const name = tr.getAttribute('data-name'); let totalHours = 0, cnt = { rest:0, reg:0, nat:0 }; let pData = currentData.filter(r => r.name === name);
Â  Â  Â  Â  pData.forEach(r => { let h = parseFloat(r.calc_hours); if(!isNaN(h)) totalHours += h; if (r.input_status === 'ä¼‘') cnt.rest++; else if (r.input_status === 'ä¾‹') cnt.reg++; else if (r.input_status === 'åœ‹') cnt.nat++; });
Â  Â  Â  Â  let msg = ""; if (monthlyTargets.hrs > 0 && totalHours > monthlyTargets.hrs) msg += `â€¢ æ‡‰æœ‰ ${totalHours.toFixed(1)} > ${monthlyTargets.hrs}<br>`; if (monthlyTargets.rest > 0 && cnt.rest > monthlyTargets.rest) msg += `â€¢ ä¼‘æ¯æ—¥ ${cnt.rest} > ${monthlyTargets.rest}<br>`; if (monthlyTargets.reg > 0 && cnt.reg > monthlyTargets.reg) msg += `â€¢ ä¾‹å‡æ—¥ ${cnt.reg} > ${monthlyTargets.reg}<br>`; if (monthlyTargets.nat > 0 && cnt.nat > monthlyTargets.nat) msg += `â€¢ åœ‹å®šå‡æ—¥ ${cnt.nat} > ${monthlyTargets.nat}<br>`;
Â  Â  Â  Â  if (msg !== "") Swal.fire({ title: 'âš ï¸ ç›®æ¨™è¶…æ¨™æé†’', html: `äººå“¡ï¼š${name}<br>${msg}`, icon: 'warning', toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
Â  Â  Â  }
Â  Â  Â  function validateAll() {
Â  Â  Â  Â  const errors = document.querySelectorAll('.row-error'); const btn = document.getElementById('btnSave');
Â  Â  Â  Â  btn.disabled = (errors.length > 0); btn.classList.toggle('btn-success', errors.length === 0); btn.classList.toggle('btn-secondary', errors.length > 0);
Â  Â  Â  }
Â  Â  Â  function showMonthlyStats() {
Â  Â  Â  Â  Â if (!currentData.length) return;
Â  Â  Â  Â  Â document.getElementById('statsTarget').innerText = `æœ¬æœˆç›®æ¨™ï¼šæ‡‰æœ‰ ${monthlyTargets.hrs} å°æ™‚ | ä¼‘ ${monthlyTargets.rest} | ä¾‹ ${monthlyTargets.reg} | åœ‹ ${monthlyTargets.nat}`;
Â  Â  Â  Â  Â let stats = {}; currentData.forEach(r => { if (!stats[r.name]) stats[r.name] = { type: r.salaryType, hrs:0, rest:0, reg:0, nat:0, empty:0 }; let s = r.input_status; if (s === 'ä¼‘') stats[r.name].rest++; else if (s === 'ä¾‹') stats[r.name].reg++; else if (s === 'åœ‹') stats[r.name].nat++; else if (s === 'ç©ºç­') stats[r.name].empty++; let h = parseFloat(r.calc_hours); if(!isNaN(h)) stats[r.name].hrs += h; });
Â  Â  Â  Â  Â const tm = document.getElementById('statsTableMonthly'); tm.innerHTML = ''; const th = document.getElementById('statsTableHourly'); th.innerHTML = '';
Â  Â  Â  Â  Â for (let n in stats) { let d = stats[n]; if (d.type.includes("æœˆè–ª")) tm.innerHTML += `<tr><td class="fw-bold">${n}</td><td>${d.hrs.toFixed(1)} (${formatDiff(d.hrs - monthlyTargets.hrs)})</td><td>${d.rest} (${formatDiff(d.rest - monthlyTargets.rest)})</td><td>${d.reg} (${formatDiff(d.reg - monthlyTargets.reg)})</td><td>${d.nat} (${formatDiff(d.nat - monthlyTargets.nat)})</td><td>${d.empty}</td></tr>`; else th.innerHTML += `<tr><td class="fw-bold">${n}</td><td>${d.hrs.toFixed(1)}</td></tr>`; }
Â  Â  Â  Â  Â new bootstrap.Modal(document.getElementById('statsModal')).show();
Â  Â  Â  }
Â  Â  Â  function showIndividualStatus() {
Â  Â  Â  Â  Â const select = document.getElementById('indivSelect'); select.innerHTML = ''; [...new Set(currentData.map(r=>r.name))].forEach(n => select.innerHTML+=`<option>${n}</option>`); renderIndividualTable(); new bootstrap.Modal(document.getElementById('indivModal')).show();
Â  Â  Â  }
Â  Â  Â  Â  // ==========================================
Â  Â  Â  // â˜…â˜…â˜… è£œå›éºå¤±çš„ï¼šå€‹äººç­è¡¨æ¸²æŸ“å‡½å¼ â˜…â˜…â˜…
Â  Â  Â  // ==========================================
Â  Â  Â  function renderPersonalPage(data) {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  document.getElementById('loadingOverlay').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginSection').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  document.getElementById('appSection').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  document.getElementById('personalSection').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  const meta = data.meta;
Â  Â  Â  Â  Â  Â  Â  document.getElementById('personalNameDisplay').innerText = `${meta.year}å¹´ ${meta.month}æœˆ - ${data.name}`;
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  // çµç®—æç¤º
Â  Â  Â  Â  Â  Â  Â  let nextMonth = (parseInt(meta.month) % 12) + 1;
Â  Â  Â  Â  Â  Â  Â  let closeDay = meta.closingDay || 1;Â 
Â  Â  Â  Â  Â  Â  Â  let noticeText = `ğŸ“… ç³»çµ±å°‡æ–¼ ${nextMonth}æœˆ${closeDay}æ—¥ 09:00 é€²è¡Œè–ªè³‡çµç®—ï¼Œå±†æ™‚å°‡è‡ªå‹•é‡ç½®ä¸¦ç”¢ç”Ÿéš”æœˆæ’ç­è³‡æ–™ã€‚`;
Â  Â  Â  Â  Â  Â  Â  document.getElementById('personalClosingNotice').innerText = noticeText;

Â  Â  Â  Â  Â  Â  Â  let totalOvertime = 0;
Â  Â  Â  Â  Â  Â  Â  if (data.data) {
Â  Â  Â  Â  Â  Â  Â  Â  Â data.data.forEach(r => { let otVal = parseFloat(r.sys_overtimeHrs); if (!isNaN(otVal)) totalOvertime += otVal; });
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  const s = data.stats;
Â  Â  Â  Â  Â  Â  Â  let leftContent = data.isHourlyÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `ç´¯è¨ˆæ‡‰æœ‰ï¼š${s.hrs.toFixed(1)} | ä¼‘ï¼š${s.rest} | ä¾‹ï¼š${s.reg} | åœ‹ï¼š${s.nat}`
Â  Â  Â  Â  Â  Â  Â  Â  Â  : `æ‡‰æœ‰ï¼š${s.hrs.toFixed(1)} (${formatDiff(s.hrs - meta.hrs)}) | ä¼‘ï¼š${s.rest} (${formatDiff(s.rest - meta.rest)}) | ä¾‹ï¼š${s.reg} (${formatDiff(s.reg - meta.reg)}) | åœ‹ï¼š${s.nat} (${formatDiff(s.nat - meta.nat)})`;
Â  Â  Â  Â  Â  Â  Â  let rightContent = totalOvertime > 0 ? `å·²ç”³è«‹åŠ ç­ç¸½æ™‚æ•¸: ${totalOvertime.toFixed(1)}` : "";
Â  Â  Â  Â  Â  Â  Â  const finalLeftContent = (data.isStoreStaff) ? leftContent : "";
Â  Â  Â  Â  Â  Â  Â  document.getElementById('personalStats').innerHTML = `<div class="d-flex justify-content-between align-items-center w-100 flex-wrap"><div class="text-center flex-grow-1">${finalLeftContent}</div><div class="text-danger fw-bold" style="min-width: 200px; text-align: right;">${rightContent}</div></div>`;
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  const tbody = document.getElementById('personalTableBody');
Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  Â  Â  Â  if (data.data.length === 0) { tbody.innerHTML = "<tr><td colspan='11' class='text-muted'>æœ¬æœˆç„¡è³‡æ–™</td></tr>"; return; }
Â  Â  Â  Â  Â  Â  Â  data.data.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  Â let dPart = r.date.split('/')[2] + "æ—¥";
Â  Â  Â  Â  Â  Â  Â  Â  Â let wDay = new Date(r.date).toLocaleDateString('zh-TW', {weekday: 'short'});
Â  Â  Â  Â  Â  Â  Â  Â  Â let planTime = (r.input_status === 'ä¸Šç­' && r.input_start) ? `${r.input_start}~${r.input_end}` : "";
Â  Â  Â  Â  Â  Â  Â  Â  Â let clockStr = (r.sys_clockIn || r.sys_clockOut) ? `${formatTime(r.sys_clockIn)}<br>${formatTime(r.sys_clockOut)}` : "";
Â  Â  Â  Â  Â  Â  Â  Â  Â let abnormalStr = r.sys_abnormal ? `<span class="badge badge-abnormal">${r.sys_abnormal}</span>` : "";
Â  Â  Â  Â  Â  Â  Â  Â  Â let leaveType = r.sys_leaveType ? `<span class="badge badge-leave">${r.sys_leaveType}</span>` : "";
Â  Â  Â  Â  Â  Â  Â  Â  Â const tr = document.createElement('tr');
Â  Â  Â  Â  Â  Â  Â  Â  Â tr.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td class="fw-bold">${dPart}<br><small class="text-muted">${wDay}</small></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td class="fw-bold text-primary">${r.input_status}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td>${planTime}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td class="fw-bold">${formatNumber(r.calc_hours)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td>${r.sys_status}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td>${clockStr}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td>${formatTime(r.sys_leave)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td>${leaveType}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td>${formatTime(r.sys_overtime)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td>${r.sys_overtimeHrs || ""}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td>${abnormalStr}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â  Â  Â tbody.appendChild(tr);
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â  alert("æ¸²æŸ“éŒ¯èª¤: " + e.message);
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  function renderIndividualTable() {
Â  Â  Â  Â  const name = document.getElementById('indivSelect').value;
Â  Â  Â  Â  const tbody = document.getElementById('indivTableBody');Â 
Â  Â  Â  Â  tbody.innerHTML = '';
Â  Â  Â  Â  const statsDiv = document.getElementById('indivStats');
Â  Â  Â  Â  document.getElementById('qrCodeContainer').style.display = 'none';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ç¯©é¸å‡ºè©²å“¡å·¥çš„è³‡æ–™
Â  Â  Â  Â  const pData = currentData.filter(r => r.name === name).sort((a,b)=>a.date.localeCompare(b.date));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (pData.length === 0) return;

Â  Â  Â  Â  // åˆ¤æ–·æ™‚è–ª/æœˆè–ª
Â  Â  Â  Â  const isHourly = (pData[0].salaryType && pData[0].salaryType.includes("æ™‚è–ª"));
Â  Â  Â  Â  let hrs=0, rest=0, reg=0, nat=0, totalOvertime=0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ 1ï¼šå˜—è©¦æŠ“å–è©²å“¡å·¥çš„é‡‘é‘° (å–ç¬¬ä¸€ç­†å³å¯) â˜…â˜…â˜…
Â  Â  Â  Â  // å¦‚æœå¾Œç«¯é‚„æ²’å‚³ pKey (ä¾‹å¦‚å¾Œç«¯é‚„æ²’éƒ¨ç½²æ–°ç‰ˆ)ï¼Œé€™è£¡æœƒæ‹¿åˆ° undefined
Â  Â  Â  Â  let userKey = pData[0].pKey || "";Â 

Â  Â  Â  Â  pData.forEach(r => {
Â  Â  Â  Â  Â  Â let h = parseFloat(r.calc_hours); if(!isNaN(h)) hrs += h;
Â  Â  Â  Â  Â  Â if (r.input_status === 'ä¼‘') rest++; else if (r.input_status === 'ä¾‹') reg++; else if (r.input_status === 'åœ‹') nat++;
Â  Â  Â  Â  Â  Â let otHrs = parseFloat(r.sys_overtimeHrs); if (!isNaN(otHrs)) totalOvertime += otHrs;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  let otDisplay = document.getElementById("totalOvertimeDisplay");
Â  Â  Â  Â  if (otDisplay) { otDisplay.innerText = totalOvertime > 0 ? "å·²ç”³è«‹åŠ ç­ç¸½æ™‚æ•¸: " + totalOvertime.toFixed(1) : ""; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ 2ï¼šæ ¹æ“šæœ‰ç„¡é‡‘é‘°ä¾†æ±ºå®šé¡¯ç¤ºä»€éº¼ â˜…â˜…â˜…
Â  Â  Â  Â  let currentBaseUrl = window.location.href.split('?')[0];Â 
Â  Â  Â  Â  let btnHtml = "";
Â  Â  Â  Â  let personalLink = "";

Â  Â  Â  Â  // æª¢æŸ¥é‡‘é‘°æ˜¯å¦å­˜åœ¨ä¸”é•·åº¦åˆç† (è‡³å°‘4ç¢¼)
Â  Â  Â  Â  if (userKey && userKey.length > 3) {
Â  Â  Â  Â  Â  Â  // æœ‰é‡‘é‘° -> ç”¢ç”Ÿå®‰å…¨é€£çµ (ä½¿ç”¨ key=...)
Â  Â  Â  Â  Â  Â  personalLink = `${currentBaseUrl}?mode=personal&key=${userKey}`;
Â  Â  Â  Â  Â  Â  btnHtml = `
Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-outline-primary fw-bold me-2" onclick="copyToClipboard('${personalLink}')">ğŸ“‹ è¤‡è£½é€£çµ</button>
Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-success fw-bold" onclick="toggleQRCode('${personalLink}')">ğŸ“± é¡¯ç¤ºQRç¢¼</button>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // ç„¡é‡‘é‘° -> é¡¯ç¤ºç´…å­—è­¦å‘Šï¼Œä¸çµ¦æŒ‰éˆ•
Â  Â  Â  Â  Â  Â  btnHtml = `<span class="badge bg-danger">âŒ æœªç”¢ç”Ÿé‡‘é‘°ï¼Œè«‹è‡³å¾Œç«¯åŸ·è¡Œã€Œç”¢ç”Ÿé€£çµç¸½è¡¨ã€</span>`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  let statText = "";
Â  Â  Â  Â  if (isHourly) {
Â  Â  Â  Â  Â  Â statText = `<strong>ç´¯è¨ˆæ‡‰æœ‰ï¼š</strong>${hrs.toFixed(1)} | <strong>ä¼‘ï¼š</strong>${rest} | <strong>ä¾‹ï¼š</strong>${reg} | <strong>åœ‹ï¼š</strong>${nat}`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â statText = `<strong>æ‡‰æœ‰ï¼š</strong>${hrs.toFixed(1)} (${formatDiff(hrs - monthlyTargets.hrs)}) | <strong>ä¼‘ï¼š</strong>${rest} (${formatDiff(rest - monthlyTargets.rest)}) | <strong>ä¾‹ï¼š</strong>${reg} (${formatDiff(reg - monthlyTargets.reg)}) | <strong>åœ‹ï¼š</strong>${nat} (${formatDiff(nat - monthlyTargets.nat)})`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // çµ„åˆç•«é¢
Â  Â  Â  Â  statsDiv.innerHTML = `<div class="d-flex justify-content-between align-items-center w-100 flex-wrap gap-2"><div style="white-space: nowrap;">${statText}</div><div>${btnHtml}</div></div>`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // å¡«å…¥è¡¨æ ¼å…§å®¹ (ä¸è®Š)
Â  Â  Â  Â  pData.forEach(r => {
Â  Â  Â  Â  Â  Â let planTimeStr = (r.input_start && String(r.input_start).trim() !== "") ? `${r.input_start}~${r.input_end}` : "";
Â  Â  Â  Â  Â  Â tbody.innerHTML += `<tr><td>${r.date}</td><td class="fw-bold text-primary">${r.input_status}</td><td style="color: #0d6efd; font-weight: bold;">${planTimeStr}</td><td>${r.calc_hours}</td><td>${r.sys_status}</td><td>${r.sys_clockIn}</td><td>${r.sys_clockOut}</td><td>${r.sys_leave}</td><td>${r.sys_leaveType}</td><td>${r.sys_overtime}</td><td>${r.sys_overtimeHrs}</td><td>${r.sys_abnormal}</td><td>${r.log}</td></tr>`;
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  let currentQRCode = null;Â 
Â  Â  Â  function toggleQRCode(url) {
Â  Â  Â  Â  Â const container = document.getElementById('qrCodeContainer');
Â  Â  Â  Â  Â const canvasBox = document.getElementById('qrCodeCanvas');
Â  Â  Â  Â  Â if (container.style.display === 'block') {
Â  Â  Â  Â  Â  Â  Â container.style.display = 'none';
Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â canvasBox.innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  Â currentQRCode = new QRCode(canvasBox, { text: url, width: 180, height: 180, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
Â  Â  Â  Â  Â  Â  Â container.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
Â  Â  Â  Â  Â }
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => { Swal.fire({ title: 'å·²è¤‡è£½é€£çµ', text: 'è«‹å‚³é€çµ¦è©²å“¡å·¥', icon: 'success', timer: 1500, showConfirmButton: false }); }); }
Â  Â  Â  function encodeNameHex(str) { const encoder = new TextEncoder(); const view = encoder.encode(str); let hex = ""; for (let i = 0; i < view.length; i++) { let h = view[i].toString(16); hex += (h.length < 2 ? "0" : "") + h; } return hex.toUpperCase(); }
Â  Â  Â  function formatNumber(v) { return v; }Â 
Â  Â  Â  function showLoading(s,t) { document.getElementById('loadingOverlay').style.display = s?'flex':'none'; if(t)document.getElementById('loadingText').innerText=t;}
Â  Â  Â  function errorHandler(e) { showLoading(false); Swal.fire('éŒ¯èª¤', e.message||e, 'error'); }
Â  Â  Â  function generateTimeOptions() { let o='<option value="">è«‹é¸æ“‡</option>'; for(let h=0;h<24;h++){ let s=('0'+h).slice(-2); o+=`<option value="${s}:00">${s}:00</option><option value="${s}:30">${s}:30</option>`; } return o; }
Â  Â  Â  function generateRestOptions() { let o='<option value="">è«‹é¸æ“‡</option>'; for(let i=0; i<=8; i++){ let v = (i * 0.5).toFixed(1); o += `<option value="${v}">${v}</option>`; } return o; }
Â  Â  Â  function createTimeSelect(v,c) { return `<select class="form-select time-select ${c}" onchange="handleRowChange(this)">${timeOptions.replace(`value="${v}"`,`value="${v}" selected`)}</select>`; }
Â  Â  Â  function createRestSelect(v) { return `<select class="form-select rest-select" onchange="handleRowChange(this)">${restOptions.replace(`value="${v}"`,`value="${v}" selected`)}</select>`; }
Â  Â  Â  function timeToFloat(t) { let p=t.split(':'); return parseInt(p[0])+(parseInt(p[1])/60); }
Â  Â  Â  function formatTime(v) { if(!v) return ""; if(v instanceof Date) return ("0"+v.getHours()).slice(-2) + ":" + ("0"+v.getMinutes()).slice(-2); let s = String(v).trim(); if (s.includes("T")) return s.substr(11, 5); return s; }
Â  Â  Â  function formatDiff(val) { let n = parseFloat(val).toFixed(1); if (Math.abs(val) < 0.1) return `<span class="text-muted">0</span>`; if (val < 0) return `<span class="diff-neg">${n}</span>`; return `<span class="diff-pos">+${n}</span>`; }
Â  Â  Â  async function handleChangePassword() {
Â  Â  Â  Â  if (!currentStore) return;
Â  Â  Â  Â  const { value: formValues } = await Swal.fire({ title: 'ğŸ”‘ è®Šæ›´ç™»å…¥å¯†ç¢¼', html: '<div class="text-start mb-2"><label class="fw-bold">ç›®å‰èˆŠå¯†ç¢¼</label><input id="swal-input1" class="form-control" type="password"></div><div class="text-start mb-2"><label class="fw-bold text-primary">è¨­å®šæ–°å¯†ç¢¼</label><input id="swal-input2" class="form-control" type="password"></div><div class="text-start"><label class="fw-bold text-primary">ç¢ºèªæ–°å¯†ç¢¼</label><input id="swal-input3" class="form-control" type="password"></div>', focusConfirm: false, showCancelButton: true, confirmButtonText: 'ç¢ºèªè®Šæ›´', cancelButtonText: 'å–æ¶ˆ', preConfirm: () => { const oldPwd = document.getElementById('swal-input1').value; const newPwd = document.getElementById('swal-input2').value; const cfmPwd = document.getElementById('swal-input3').value; if (!oldPwd || !newPwd || !cfmPwd) { Swal.showValidationMessage('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½'); return false; } if (newPwd !== cfmPwd) { Swal.showValidationMessage('å…©æ¬¡æ–°å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´'); return false; } return { oldPwd: oldPwd, newPwd: newPwd }; } });
Â  Â  Â  Â  if (formValues) { showLoading(true, "æ›´æ–°å¯†ç¢¼ä¸­..."); callApi('changePassword', { store: currentStore, oldPwd: formValues.oldPwd, newPwd: formValues.newPwd }).then(res => { showLoading(false); if (res.success) { Swal.fire({ icon: 'success', title: 'æˆåŠŸ', text: res.message }).then(() => logout()); } else { Swal.fire('è®Šæ›´å¤±æ•—', res.message, 'error'); } }).catch(err => errorHandler(err)); }
Â  Â  Â  }
Â  Â  </script>
Â  </body>
</html>
