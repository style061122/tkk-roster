<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–€å¸‚æ’ç­ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; }
      .main-container { max-width: 1400px; margin: 20px auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
      #loginSection { max-width: 400px; margin: 100px auto; text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
      .table th { vertical-align: middle; text-align: center; white-space: nowrap; font-size: 0.95rem; background-color: #343a40; color: white; }
      .table td { vertical-align: middle; padding: 8px 5px; font-size: 1rem; text-align: center; }
      input:read-only, select:disabled { background-color: #e9ecef; cursor: not-allowed; color: #6c757d; }
      .row-error { background-color: #ffe6e6 !important; }
      .row-warning { background-color: #fff3cd !important; }
      .msg-box { font-size: 0.85em; font-weight: bold; line-height: 1.3; display: block; min-height: 18px; }
      .text-err { color: #dc3545; } .text-warn { color: #856404; }
      #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
      .diff-pos { color: green; font-weight: bold; } 
      .diff-neg { color: red; font-weight: bold; }
      .view-btn.active { background-color: #0d6efd; color: white; border-color: #0d6efd; }
      .filter-group { display: flex; align-items: center; margin-right: 15px; }
      .custom-select-day { width: 100px !important; }
      .custom-select-name { width: 160px !important; }
      #liveSummaryBar { background-color: #fff3cd; border: 1px solid #ffecb5; border-radius: 8px; padding: 10px 15px; margin-bottom: 15px; display: none; font-size: 1rem; color: #664d03; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
      .swal2-container { z-index: 100000 !important; }
      .badge-abnormal { background-color: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }
      .badge-leave { background-color: #ffc107; color: black; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }
      #personalStats { background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; color: #495057; font-size: 1.1rem; }
    </style>
  </head>
  <body>
    <div id="loadingOverlay"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div><h5 class="mt-3 text-dark fw-bold" id="loadingText">ç³»çµ±è¼‰å…¥ä¸­...</h5></div>
    <div id="loginSection" style="display:none;">
      <h3 class="mb-4 fw-bold text-primary">é ‚å‘±å‘±é–€å¸‚æ’ç­ç³»çµ±</h3>
      <div class="mb-3 text-start"><label class="form-label fw-bold">æ‰€å±¬å…¬å¸</label><select id="loginCompany" class="form-select form-select-lg" onchange="updateStoreOptions()"><option value="">è¼‰å…¥ä¸­...</option></select></div>
      <div class="mb-3 text-start"><label class="form-label fw-bold">é¸æ“‡é–€å¸‚</label><select id="loginStore" class="form-select form-select-lg"><option value="">è«‹å…ˆé¸æ“‡å…¬å¸</option></select></div>
      <div class="mb-4 text-start"><label class="form-label fw-bold">ç™»å…¥å¯†ç¢¼</label><input type="password" id="loginPassword" class="form-control form-select-lg" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"></div>
      <div class="d-grid"><button class="btn btn-primary btn-lg fw-bold shadow" onclick="handleLogin()">ç™»å…¥ç³»çµ±</button></div>
    </div>
    <div id="appSection" class="main-container" style="display:none;">
      <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3 flex-wrap gap-3">
        <div><h2 class="fw-bold text-primary mb-1"><span id="displayStoreName"></span> æ’ç­è¡¨</h2><span class="badge bg-secondary fs-6" id="monthTargetInfo">è¼‰å…¥ä¸­...</span></div>
        <div class="d-flex gap-2 align-items-center flex-wrap">
           <div class="d-flex align-items-center border rounded px-2 py-1 bg-light"><span id="displayYear" class="fw-bold fs-5 text-primary">2026</span><span class="mx-1">å¹´</span><span id="displayMonth" class="fw-bold fs-5 text-primary">1</span><span class="mx-1">æœˆ</span></div>
           <div class="btn-group"><button class="btn btn-outline-primary view-btn active" id="btnModeDate" onclick="switchMode('date')">ğŸ“… ä¾æ—¥æœŸæ’ç­</button><button class="btn btn-outline-primary view-btn" id="btnModeName" onclick="switchMode('name')">ğŸ‘¤ ä¾äººåæ’ç­</button></div>
           <div id="filterContainer" class="d-flex"><div id="filterDateGroup" class="filter-group"><label class="fw-bold mx-2">æ—¥ï¼š</label><select id="selectDay" class="form-select fw-bold border-primary custom-select-day" onchange="renderTable()"></select></div><div id="filterNameGroup" class="filter-group" style="display:none;"><label class="fw-bold mx-2">äººå“¡ï¼š</label><select id="selectName" class="form-select fw-bold border-primary custom-select-name" onchange="renderTable()"></select></div></div>
           <button class="btn btn-info text-white fw-bold" onclick="showMonthlyStats()">ğŸ“Š æœˆçµ±è¨ˆ</button><button class="btn btn-warning text-dark fw-bold" onclick="showIndividualStatus()">ğŸ‘¤ ç³»çµ±ç‹€æ…‹</button><button class="btn btn-secondary fw-bold" onclick="handleChangePassword()">ğŸ”‘ å¯†ç¢¼è®Šæ›´</button><button class="btn btn-outline-danger fw-bold" onclick="logout()">ç™»å‡º</button>
        </div>
      </div>
      <form id="scheduleForm">
        <div class="table-responsive"><table class="table table-bordered table-hover align-middle"><thead><tr id="tableHeaderRow"><th style="width:12%">å§“å/æ—¥æœŸ</th><th style="width:15%">ç‹€æ…‹ (D)</th><th style="width:13%">ä¸Šç­ (E)</th><th style="width:13%">ä¸‹ç­ (F)</th><th style="width:10%">ä¼‘æ¯ (G)</th><th style="width:8%">æ™‚æ•¸ (H)</th><th style="width:29%">æª¢æ ¸è¨Šæ¯</th></tr></thead><tbody id="staffTable"></tbody></table></div>
        <div id="liveSummaryBar"></div>
        <div class="d-grid gap-2 mt-3"><button type="button" id="btnSave" class="btn btn-success btn-lg fw-bold shadow-sm" onclick="saveData(false)">ğŸ’¾ ç¢ºèªå„²å­˜ç­è¡¨</button></div>
      </form>
    </div>
    <div id="personalSection" class="container" style="display:none; max-width: 1400px; margin-top: 20px;">
       <h3 class="text-center fw-bold text-primary mb-2">ğŸ“… å€‹äººç­è¡¨èˆ‡å‡ºå‹¤ç´€éŒ„</h3><h5 class="text-center text-secondary mb-4" id="personalNameDisplay">è¼‰å…¥ä¸­...</h5>
       <div id="personalStats"></div>
       <div class="table-responsive"><table class="table table-bordered table-hover table-striped"><thead><tr><th style="width: 8%">æ—¥æœŸ</th><th style="width: 8%">ç­è¡¨ç‹€æ…‹</th><th style="width: 10%">æ’ç­æ™‚é–“</th><th style="width: 6%">æ‡‰æœ‰æ™‚æ•¸<br>(H)</th><th style="width: 8%">ç³»çµ±ç‹€æ…‹<br>(I)</th><th style="width: 10%">å¯¦éš›æ‰“å¡<br>(ä¸Šç­/ä¸‹ç­)</th><th style="width: 10%">è«‹å‡æ™‚é–“<br>(L)</th><th style="width: 8%">å‡åˆ¥<br>(M)</th><th style="width: 10%">åŠ ç­æ™‚é–“<br>(N)</th><th style="width: 6%">åŠ ç­æ™‚æ•¸<br>(O)</th><th style="width: 10%">ç•°å¸¸<br>(P)</th></tr></thead><tbody id="personalTableBody"></tbody></table></div>
    </div>
    <div class="modal fade" id="statsModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-info text-white"><h5 class="modal-title fw-bold">ğŸ“Š æœ¬æœˆæ’ç­çµ±è¨ˆ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-light border d-flex justify-content-around fw-bold mb-3 text-dark bg-light" id="statsTarget"></div><h6 class="fw-bold text-primary border-bottom pb-2 mt-3">ğŸ”µ æœˆè–ªåˆ¶äººå“¡</h6><div class="table-responsive mb-4"><table class="table table-sm table-bordered text-center align-middle table-striped"><thead class="table-light"><tr><th>å§“å</th><th>æ‡‰æœ‰æ™‚æ•¸(å·®)</th><th>ä¼‘(å·®)</th><th>ä¾‹(å·®)</th><th>åœ‹å®š(å·®)</th><th>ç©ºç­</th></tr></thead><tbody id="statsTableMonthly"></tbody></table></div><h6 class="fw-bold text-success border-bottom pb-2">ğŸŸ¢ æ™‚è–ªåˆ¶äººå“¡</h6><div class="table-responsive"><table class="table table-sm table-bordered text-center align-middle table-striped"><thead class="table-light"><tr><th>å§“å</th><th>ç´¯è¨ˆæ‡‰æœ‰</th></tr></thead><tbody id="statsTableHourly"></tbody></table></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button></div></div></div></div>
    <div class="modal fade" id="indivModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title fw-bold text-dark">ğŸ‘¤ ç›®å‰ç³»çµ±ç‹€æ…‹ (æ•´æœˆæª¢è¦–)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3 d-flex align-items-center flex-wrap gap-2"><label class="fw-bold">é¸æ“‡äººå“¡ï¼š</label><select id="indivSelect" class="form-select w-auto" onchange="renderIndividualTable()"></select><div id="indivStats" class="stat-info"></div><span id="totalOvertimeDisplay" style="margin-left: auto; color: #dc3545; font-weight: bold; font-size: 1.2em;"></span></div><div class="table-responsive"><table class="table table-sm table-striped table-bordered text-center" style="font-size: 0.9em;"><thead class="table-dark"><tr><th>æ—¥æœŸ</th><th>ç­è¡¨(D)</th><th>æ’ç­æ™‚é–“</th><th>æ‡‰æœ‰(H)</th><th>ç³»çµ±ç‹€æ…‹(I)</th><th>ä¸Šç­å¡</th><th>ä¸‹ç­å¡</th><th>è«‹å‡</th><th>å‡åˆ¥</th><th>åŠ ç­</th><th>åŠ ç­æ™‚æ•¸</th><th>ç•°å¸¸</th><th>è¨»è¨˜(Q)</th></tr></thead><tbody id="indivTableBody"></tbody></table></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button></div></div></div></div>

    <script>
      // â˜…â˜…â˜… æ‚¨çš„å¾Œç«¯ API ç¶²å€ â˜…â˜…â˜…
      const API_URL = "https://script.google.com/macros/s/AKfycbyTyDUDwLqB8yuLu92VFDfXWdVDfpjL8KCTbzFsnB7Oana7znctc_8tAVwYFr8xaLNt/exec";

      let currentStore = "", currentData = [], monthlyTargets = { hrs:0, rest:0, reg:0, nat:0, holidays:[], weekStart: 1, customRules:[] };
      let currentParams = {}, currentMode = 'date', allStoreData = {}; 
      const statusOpts = ["", "ä¸Šç­", "ä¼‘", "ä¾‹", "åœ‹", "ç©ºç­"];
      const timeOptions = generateTimeOptions(), restOptions = generateRestOptions();

      window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode'), userParam = urlParams.get('u');
        if (mode === 'personal' && userParam) {
           document.getElementById('loadingOverlay').style.display = 'flex';
           document.getElementById('loadingText').innerText = "è®€å–å€‹äººç­è¡¨ä¸­...";
           callApi('getPersonalData', { u: userParam })
             .then(res => {
                showLoading(false);
                if (res.success) renderPersonalPage(res);
                else document.body.innerHTML = `<div class="container text-center text-danger mt-5"><h3>âŒ ${res.message}</h3></div>`;
             })
             .catch(err => {
                showLoading(false);
                alert("éŒ¯èª¤ï¼š" + err.message); // ä½¿ç”¨ alert ç¢ºä¿æ‰‹æ©Ÿçœ‹å¾—åˆ°éŒ¯èª¤
             });
        } else {
           showLoading(true, "é€£ç·šä¸­...");
           callApi('getStoreList').then(res => {
               if (res.success) initLogin(res.data);
               else { showLoading(false); Swal.fire('éŒ¯èª¤', 'ç„¡æ³•å–å¾—é–€å¸‚æ¸…å–®', 'error'); }
           }).catch(err => errorHandler(err));
        }
      };

// ==========================================
      // API å‘¼å«æ ¸å¿ƒ (ä¿®æ­£ç‰ˆï¼šé¿é–‹ CORS æª¢æŸ¥)
      // ==========================================
      function callApi(op, params = {}) {
         params.op = op;
         return fetch(API_URL, {
             method: 'POST',
             // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šå¿…é ˆç”¨ text/plainï¼Œå¦å‰‡æœƒå‡ºç¾ Failed to fetch â˜…â˜…â˜…
             headers: { 'Content-Type': 'text/plain;charset=utf-8' },
             body: JSON.stringify(params)
         }).then(response => {
             return response.text().then(text => {
                 try {
                     return JSON.parse(text);
                 } catch (e) {
                     console.error("API Error Raw:", text);
                     throw new Error("å¾Œç«¯å›æ‡‰é JSON æ ¼å¼");
                 }
             });
         });
      }

      function renderPersonalPage(data) {
          try {
              document.getElementById('loadingOverlay').style.display = 'none';
              document.getElementById('loginSection').style.display = 'none';
              document.getElementById('appSection').style.display = 'none';
              document.getElementById('personalSection').style.display = 'block';
              const meta = data.meta;
              document.getElementById('personalNameDisplay').innerText = `${meta.year}å¹´ ${meta.month}æœˆ - ${data.name}`;
              let totalOvertime = 0;
              if (data.data) {
                 data.data.forEach(r => { let otVal = parseFloat(r.sys_overtimeHrs); if (!isNaN(otVal)) totalOvertime += otVal; });
              }
              const s = data.stats;
              let leftContent = data.isHourly 
                  ? `ç´¯è¨ˆæ‡‰æœ‰ï¼š${s.hrs.toFixed(1)} | ä¼‘ï¼š${s.rest} | ä¾‹ï¼š${s.reg} | åœ‹ï¼š${s.nat}`
                  : `æ‡‰æœ‰ï¼š${s.hrs.toFixed(1)} (${formatDiff(s.hrs - meta.hrs)}) | ä¼‘ï¼š${s.rest} (${formatDiff(s.rest - meta.rest)}) | ä¾‹ï¼š${s.reg} (${formatDiff(s.reg - meta.reg)}) | åœ‹ï¼š${s.nat} (${formatDiff(s.nat - meta.nat)})`;
              let rightContent = totalOvertime > 0 ? `å·²ç”³è«‹åŠ ç­ç¸½æ™‚æ•¸: ${totalOvertime.toFixed(1)}` : "";
              const finalLeftContent = (data.isStoreStaff) ? leftContent : "";
              document.getElementById('personalStats').innerHTML = `<div class="d-flex justify-content-between align-items-center w-100 flex-wrap"><div class="text-center flex-grow-1">${finalLeftContent}</div><div class="text-danger fw-bold" style="min-width: 200px; text-align: right;">${rightContent}</div></div>`;
              const tbody = document.getElementById('personalTableBody');
              tbody.innerHTML = "";
              if (data.data.length === 0) { tbody.innerHTML = "<tr><td colspan='11' class='text-muted'>æœ¬æœˆç„¡è³‡æ–™</td></tr>"; return; }
              data.data.forEach(r => {
                 let dPart = r.date.split('/')[2] + "æ—¥";
                 let wDay = new Date(r.date).toLocaleDateString('zh-TW', {weekday: 'short'});
                 let planTime = (r.input_status === 'ä¸Šç­' && r.input_start) ? `${r.input_start}~${r.input_end}` : "";
                 let clockStr = (r.sys_clockIn || r.sys_clockOut) ? `${formatTime(r.sys_clockIn)}<br>${formatTime(r.sys_clockOut)}` : "";
                 let abnormalStr = r.sys_abnormal ? `<span class="badge badge-abnormal">${r.sys_abnormal}</span>` : "";
                 let leaveType = r.sys_leaveType ? `<span class="badge badge-leave">${r.sys_leaveType}</span>` : "";
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                   <td class="fw-bold">${dPart}<br><small class="text-muted">${wDay}</small></td>
                   <td class="fw-bold text-primary">${r.input_status}</td>
                   <td>${planTime}</td>
                   <td class="fw-bold">${formatNumber(r.calc_hours)}</td>
                   <td>${r.sys_status}</td>
                   <td>${clockStr}</td>
                   <td>${formatTime(r.sys_leave)}</td>
                   <td>${leaveType}</td>
                   <td>${formatTime(r.sys_overtime)}</td>
                   <td>${r.sys_overtimeHrs || ""}</td>
                   <td>${abnormalStr}</td>
                 `;
                 tbody.appendChild(tr);
              });
          } catch(e) {
              alert("æ¸²æŸ“éŒ¯èª¤: " + e.message);
          }
      }

      function initLogin(data) {
        showLoading(false); allStoreData = data || {}; 
        const coSelect = document.getElementById('loginCompany');
        coSelect.innerHTML = '<option value="">è«‹é¸æ“‡å…¬å¸</option>';
        Object.keys(allStoreData).forEach(co => { coSelect.innerHTML += `<option value="${co}">${co}</option>`; });
        document.getElementById('loginSection').style.display = 'block';
      }
      function updateStoreOptions() {
        const company = document.getElementById('loginCompany').value;
        const storeSelect = document.getElementById('loginStore');
        storeSelect.innerHTML = '<option value="">è«‹é¸æ“‡é–€å¸‚</option>';
        if (company && allStoreData[company]) {
            allStoreData[company].forEach(store => { storeSelect.innerHTML += `<option value="${store}">${store}</option>`; });
        }
      }
      function handleLogin() {
        const store = document.getElementById('loginStore').value;
        const pwd = document.getElementById('loginPassword').value;
        if (!store || !pwd) { Swal.fire('éŒ¯èª¤', 'è«‹å¡«å¯«å®Œæ•´', 'error'); return; }
        showLoading(true, "é©—è­‰ä¸­...");
        callApi('login', { store: store, pwd: pwd }).then(res => {
             showLoading(false);
             if (res.success) {
                currentStore = store;
                document.getElementById('displayStoreName').innerText = store;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('appSection').style.display = 'block';
                loadData();
             } else { Swal.fire('ç™»å…¥å¤±æ•—', res.message, 'error'); }
        }).catch(err => errorHandler(err));
      }
      function logout() { 
        currentStore = ""; currentData = [];
        document.getElementById('loginPassword').value = "";
        document.getElementById('selectName').innerHTML = ""; 
        document.getElementById('selectDay').innerHTML = "";
        document.getElementById('staffTable').innerHTML = "";
        switchMode('date'); 
        document.getElementById('loginStore').innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å…¬å¸</option>';
        document.getElementById('loginCompany').value = ""; 
        document.getElementById('appSection').style.display = 'none';
        document.getElementById('loginSection').style.display = 'block';
        showLoading(false);
      }
      function loadData() {
        if (!currentStore) return;
        showLoading(true, "è®€å–è³‡æ–™ä¸­...");
        callApi('getStoreData', { store: currentStore }).then(res => {
             showLoading(false);
             if (res.success) {
                 currentData = res.data || []; monthlyTargets = res.targets || {}; currentParams = res.params || {};
                 const year = monthlyTargets.year || new Date().getFullYear();
                 const month = monthlyTargets.month || (new Date().getMonth()+1);
                 document.getElementById('displayYear').innerText = year;
                 document.getElementById('displayMonth').innerText = month;
                 document.getElementById('monthTargetInfo').innerText = `ç›®æ¨™: æ‡‰æœ‰${monthlyTargets.hrs} | ä¼‘${monthlyTargets.rest} | ä¾‹${monthlyTargets.reg} | åœ‹${monthlyTargets.nat}`;
                 if(document.getElementById('selectDay').options.length === 0) initDaySelect(year, month);
                 initNameSelect(); renderTable();
             } else { Swal.fire('éŒ¯èª¤', 'è³‡æ–™è®€å–å¤±æ•—', 'error'); }
        }).catch(err => errorHandler(err));
      }
      function initDaySelect(year, month) {
        const select = document.getElementById('selectDay'); select.innerHTML = '';
        const daysInMonth = new Date(year, month, 0).getDate(); const today = new Date().getDate();
        for(let d=1; d<=daysInMonth; d++) { let selected = (d === today) ? "selected" : ""; select.innerHTML += `<option value="${d}" ${selected}>${d} æ—¥</option>`; }
      }
      function initNameSelect() {
        const select = document.getElementById('selectName'); select.innerHTML = '';
        const names = [...new Set(currentData.map(r => r.name))];
        names.forEach(n => select.innerHTML += `<option value="${n}">${n}</option>`);
      }
      function switchMode(mode) {
        currentMode = mode;
        document.getElementById('btnModeDate').classList.toggle('active', mode === 'date');
        document.getElementById('btnModeName').classList.toggle('active', mode === 'name');
        document.getElementById('filterDateGroup').style.display = (mode === 'date') ? 'flex' : 'none';
        document.getElementById('filterNameGroup').style.display = (mode === 'name') ? 'flex' : 'none';
        document.getElementById('tableHeaderRow').cells[0].innerText = (mode === 'date') ? "å§“å" : "æ—¥æœŸ";
        renderTable();
      }
      function getWeeklyUsage(name, dateStr) {
         let currDate = new Date(dateStr);
         let startDayParam = monthlyTargets.weekStart || 1; 
         let day = currDate.getDay(); 
         let adjDay = (day === 0 ? 7 : day) - startDayParam; if (adjDay < 0) adjDay += 7;
         let weekStart = new Date(currDate); weekStart.setDate(currDate.getDate() - adjDay);
         let weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 6);
         let personData = currentData.filter(r => r.name === name).map(r => ({...r}));
         if (currentMode === 'name') {
             const rows = document.querySelectorAll('#staffTable tr');
             rows.forEach(tr => {
                 let d = tr.getAttribute('data-date'); let s = tr.querySelector('.status-select').value;
                 let t = personData.find(x => x.date === d); if (t) t.input_status = s; 
             });
         }
         let weekData = personData.filter(r => { let d = new Date(r.date); return d >= weekStart && d <= weekEnd; });
         let usage = { rest: 0, reg: 0 };
         weekData.forEach(r => { if (r.input_status === 'ä¼‘') usage.rest++; if (r.input_status === 'ä¾‹') usage.reg++; });
         return usage;
      }
      function getRangeUsage(name, type, startDay, endDay) {
         let personData = currentData.filter(r => r.name === name).map(r => ({...r}));
         if (currentMode === 'name') {
             const rows = document.querySelectorAll('#staffTable tr');
             rows.forEach(tr => {
                 let d = tr.getAttribute('data-date'); let s = tr.querySelector('.status-select').value;
                 let t = personData.find(x => x.date === d); if (t) t.input_status = s; 
             });
         }
         let count = 0;
         personData.forEach(r => { let d = parseInt(r.date.split('/')[2]); if (d >= startDay && d <= endDay && r.input_status === type) count++; });
         return count;
      }
      function renderTable() {
        const tbody = document.getElementById('staffTable'); tbody.innerHTML = '';
        const summaryBar = document.getElementById('liveSummaryBar'); summaryBar.style.display = 'none'; 
        const y = document.getElementById('displayYear').innerText; const m = document.getElementById('displayMonth').innerText.padStart(2, '0');
        let targetData = [], targetName = "";
        if (currentMode === 'date') {
           const d = document.getElementById('selectDay').value.padStart(2, '0'); const targetDateStr = `${y}/${m}/${d}`;
           targetData = currentData.filter(row => row.date === targetDateStr);
        } else {
           targetName = document.getElementById('selectName').value; targetData = currentData.filter(row => row.name === targetName);
           targetData.sort((a,b) => a.date.localeCompare(b.date)); summaryBar.style.display = 'block'; 
        }
        if (targetData.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted fw-bold">ç„¡è³‡æ–™</td></tr>'; if(currentMode === 'name') updateLiveSummary(targetName); return; }
        targetData.forEach((row) => {
          let originalIndex = currentData.indexOf(row);
          let tr = document.createElement('tr');
          tr.setAttribute('data-index', originalIndex); tr.setAttribute('data-salary', row.salaryType); tr.setAttribute('data-name', row.name); tr.setAttribute('data-date', row.date);
          let col1Content = (currentMode === 'date') ? `<div class="fw-bold fs-5">${row.name}</div><span class="badge bg-${row.salaryType.includes("æœˆè–ª") ? "primary" : "success"} rounded-pill">${row.salaryType}</span>` : `<div class="fw-bold fs-5">${row.date.split('/')[2]} æ—¥ <small class="text-muted fs-6">(${new Date(row.date).toLocaleDateString('zh-TW', {weekday: 'short'})})</small></div><span class="badge bg-${row.salaryType.includes("æœˆè–ª") ? "primary" : "success"} rounded-pill">${row.salaryType}</span>`;
          tr.innerHTML += `<td>${col1Content}</td>`;
          let statusHtml = `<select class="form-select status-select fw-bold border-dark" onchange="handleRowChange(this)">`;
          let currentDay = parseInt(row.date.split('/')[2]);
          let isHourlyHoliday = (monthlyTargets.holidays || []).includes(currentDay.toString());
          let allowed = [];
          if (row.salaryType.includes("æ™‚è–ª")) {
             let usage = getWeeklyUsage(row.name, row.date);
             if (isHourlyHoliday) allowed = ["", "ä¸Šç­", "åœ‹"];
             else { allowed = ["", "ä¸Šç­", "ç©ºç­"]; if (usage.rest < 1 || row.input_status === 'ä¼‘') allowed.push("ä¼‘"); if (usage.reg < 1 || row.input_status === 'ä¾‹') allowed.push("ä¾‹"); }
          } else {
             let activeRules = (monthlyTargets.customRules || []).filter(r => currentDay >= r.start && currentDay <= r.end);
             if (activeRules.length > 0) {
                 allowed = ["", "ç©ºç­"]; let hasWorkRule = activeRules.some(r => r.type === 'ä¸Šç­'); if (!hasWorkRule) allowed.push("ä¸Šç­");
                 activeRules.forEach(r => { let used = getRangeUsage(row.name, r.type, r.start, r.end); if (used < r.limit || row.input_status === r.type) { if (!allowed.includes(r.type)) allowed.push(r.type); } });
             } else { allowed = statusOpts; }
          }
          if (row.input_status && !allowed.includes(row.input_status)) allowed.push(row.input_status);
          statusOpts.forEach(opt => { if (allowed.includes(opt)) { let selected = (row.input_status === opt) ? "selected" : ""; statusHtml += `<option value="${opt}" ${selected}>${opt || "è«‹é¸æ“‡"}</option>`; } });
          statusHtml += `</select>`;
          tr.innerHTML += `<td>${statusHtml}</td>`;
          tr.innerHTML += `<td>${createTimeSelect(row.input_start, 'start-select')}</td><td>${createTimeSelect(row.input_end, 'end-select')}</td><td>${createRestSelect(row.input_rest)}</td><td><input type="text" class="form-control text-center fw-bold hours-input border-0 bg-transparent" value="${row.calc_hours}" readonly></td><td><div class="msg-box"></div></td>`;
          tbody.appendChild(tr); updateRowState(tr); validateRow(tr);    
        });
        if (currentMode === 'name') updateLiveSummary(targetName);
      }
      function handleRowChange(element) {
        let tr = element.closest('tr'); let idx = parseInt(tr.getAttribute('data-index'));
        currentData[idx].input_status = tr.querySelector('.status-select').value;
        currentData[idx].input_start = tr.querySelector('.start-select').value;
        currentData[idx].input_end = tr.querySelector('.end-select').value;
        currentData[idx].input_rest = tr.querySelector('.rest-select').value;
        updateRowState(tr); calculateRow(tr); currentData[idx].calc_hours = tr.querySelector('.hours-input').value;
        if (currentMode === 'name') { let salary = tr.getAttribute('data-salary'); let name = tr.getAttribute('data-name'); if (salary.includes("æ™‚è–ª")) refreshHourlyDropdowns(name); else if (salary.includes("æœˆè–ª")) refreshMonthlyDropdowns(name); updateLiveSummary(name); }
        validateRow(tr); checkRealTimeBudget(tr); validateAll();
      }
      function refreshHourlyDropdowns(name) {
         const rows = document.querySelectorAll('#staffTable tr');
         rows.forEach(tr => {
             if (tr.getAttribute('data-name') !== name) return;
             const dateStr = tr.getAttribute('data-date'); const select = tr.querySelector('.status-select'); const currentVal = select.value;
             let usage = getWeeklyUsage(name, dateStr); let currentDay = parseInt(dateStr.split('/')[2]).toString();
             let isHourlyHoliday = (monthlyTargets.holidays || []).includes(currentDay);
             let allowed = [];
             if (isHourlyHoliday) allowed = ["", "ä¸Šç­", "åœ‹"]; else { allowed = ["", "ä¸Šç­", "ç©ºç­"]; if (usage.rest < 1 || currentVal === 'ä¼‘') allowed.push("ä¼‘"); if (usage.reg < 1 || currentVal === 'ä¾‹') allowed.push("ä¾‹"); }
             if (currentVal && !allowed.includes(currentVal)) allowed.push(currentVal);
             let newHtml = ""; statusOpts.forEach(opt => { if (allowed.includes(opt)) { let selected = (currentVal === opt) ? "selected" : ""; newHtml += `<option value="${opt}" ${selected}>${opt || "è«‹é¸æ“‡"}</option>`; } });
             if (select.innerHTML !== newHtml) { select.innerHTML = newHtml; select.value = currentVal; }
         });
      }
      function refreshMonthlyDropdowns(name) {
         const rows = document.querySelectorAll('#staffTable tr');
         rows.forEach(tr => {
             if (tr.getAttribute('data-name') !== name) return;
             const dateStr = tr.getAttribute('data-date'); const select = tr.querySelector('.status-select'); const currentVal = select.value;
             const currentDay = parseInt(dateStr.split('/')[2]);
             let activeRules = (monthlyTargets.customRules || []).filter(r => currentDay >= r.start && currentDay <= r.end);
             let allowed = [];
             if (activeRules.length > 0) { allowed = ["", "ç©ºç­"]; let hasWorkRule = activeRules.some(r => r.type === 'ä¸Šç­'); if (!hasWorkRule) allowed.push("ä¸Šç­"); activeRules.forEach(r => { let used = getRangeUsage(name, r.type, r.start, r.end); if (used < r.limit || currentVal === r.type) { if (!allowed.includes(r.type)) allowed.push(r.type); } }); } else { allowed = statusOpts; }
             if (currentVal && !allowed.includes(currentVal)) allowed.push(currentVal);
             let newHtml = ""; statusOpts.forEach(opt => { if (allowed.includes(opt)) { let selected = (currentVal === opt) ? "selected" : ""; newHtml += `<option value="${opt}" ${selected}>${opt || "è«‹é¸æ“‡"}</option>`; } });
             if (select.innerHTML !== newHtml) { select.innerHTML = newHtml; select.value = currentVal; }
         });
      }
      function updateLiveSummary(name) {
         if (!name) return;
         let pData = currentData.filter(r => r.name === name);
         let hrs = 0, rest = 0, reg = 0, nat = 0, empty = 0;
         pData.forEach(r => { let h = parseFloat(r.calc_hours); if(!isNaN(h)) hrs += h; if (r.input_status === 'ä¼‘') rest++; else if (r.input_status === 'ä¾‹') reg++; else if (r.input_status === 'åœ‹') nat++; else if (r.input_status === 'ç©ºç­') empty++; });
         const bar = document.getElementById('liveSummaryBar');
         bar.innerHTML = `<span class="me-3">ç›®å‰ç´¯è¨ˆ (${name})ï¼š</span> æ‡‰æœ‰ <span class="${getDiffClass(hrs, monthlyTargets.hrs)}">${hrs.toFixed(1)}</span> / ä¼‘ <span class="${getDiffClass(rest, monthlyTargets.rest)}">${rest}</span> / ä¾‹ <span class="${getDiffClass(reg, monthlyTargets.reg)}">${reg}</span> / åœ‹ <span class="${getDiffClass(nat, monthlyTargets.nat)}">${nat}</span> / ç©ºç­ ${empty}`;
      }
      function getDiffClass(val, target) { if (val > target) return 'text-danger'; if (val < target) return 'text-primary'; return 'text-success'; }
      function updateRowState(tr) {
        const status = tr.querySelector('.status-select').value; const inputs = tr.querySelectorAll('.time-select, .rest-select'); const hInput = tr.querySelector('.hours-input');
        if (status === 'ä¸Šç­') { inputs.forEach(el => { el.disabled = false; el.classList.remove('bg-light'); }); } else { inputs.forEach(el => { el.disabled = true; el.classList.add('bg-light'); el.value = ""; }); hInput.value = ""; tr.querySelector('.msg-box').innerHTML = ""; tr.classList.remove('row-error', 'row-warning'); }
      }
      function calculateRow(tr) {
        const status = tr.querySelector('.status-select').value; if (status !== 'ä¸Šç­') return;
        const s = tr.querySelector('.start-select').value; const e = tr.querySelector('.end-select').value; const r = tr.querySelector('.rest-select').value; const hInput = tr.querySelector('.hours-input');
        if (s && e && r !== "") { let start = timeToFloat(s), end = timeToFloat(e), rest = parseFloat(r); if (end < start) end += 24; let total = end - start - rest; hInput.value = (total > 0) ? total.toFixed(1) : "0.0"; } else { hInput.value = ""; }
      }
      function validateRow(tr) {
        const status = tr.querySelector('.status-select').value; const msgBox = tr.querySelector('.msg-box'); const salaryType = tr.getAttribute('data-salary'); const dateStr = tr.getAttribute('data-date'); 
        const hVal = parseFloat(tr.querySelector('.hours-input').value) || 0; const rVal = parseFloat(tr.querySelector('.rest-select').value) || 0;
        msgBox.innerHTML = ""; tr.classList.remove('row-error', 'row-warning'); let errors = [], warnings = [];
        let currentDay = parseInt(dateStr.split('/')[2]).toString(); let isHourlyHoliday = (monthlyTargets.holidays || []).includes(currentDay);
        if (salaryType.includes("æ™‚è–ª") && isHourlyHoliday && status === "åœ‹") warnings.push("âš ï¸ æ™‚è–ªäººå“¡å¦‚æœ‰å‡ºå‹¤ï¼Œç‹€æ…‹è«‹æ”¹ç‚º'ä¸Šç­'");
        if (salaryType.includes("æœˆè–ª") && status === "åœ‹") warnings.push("âš ï¸ æœˆè–ªäººå“¡å¦‚æœ‰å‡ºå‹¤ï¼Œè«‹æ•´å¤©ç”³è«‹åŠ ç­å–®");
        if (salaryType.includes("æœˆè–ª") && status === "ç©ºç­") warnings.push("âš ï¸ ç•¶æœˆæ‡‰æœ‰æ™‚æ•¸å¤§æ–¼8æ‰æœƒç”¢ç”Ÿç©ºç­");
        if (status === 'ä¸Šç­' && tr.querySelector('.start-select').value) { if (salaryType.includes("æœˆè–ª") && hVal > 10) errors.push("âŒ æœˆè–ªåˆ¶ä¸å¯>10å°æ™‚"); else if (salaryType.includes("æ™‚è–ª") && hVal > 8) errors.push("âŒ æ™‚è–ªåˆ¶ä¸å¯>8å°æ™‚"); if (hVal > 8 && rVal < 1) errors.push("âŒ >8å°æ™‚éœ€ä¼‘1å°æ™‚"); else if (hVal > 4 && rVal < 0.5) errors.push("âŒ >4å°æ™‚éœ€ä¼‘0.5å°æ™‚"); }
        if (errors.length > 0) { msgBox.innerHTML = errors.map(e=>`<span class="text-err">${e}</span>`).join("<br>"); tr.classList.add('row-error'); } else if (warnings.length > 0) { msgBox.innerHTML = warnings.map(w=>`<span class="text-warn">${w}</span>`).join("<br>"); tr.classList.add('row-warning'); }
      }
      function checkRealTimeBudget(tr) {
        if (!currentData.length) return; const name = tr.getAttribute('data-name'); let totalHours = 0, cnt = { rest:0, reg:0, nat:0 }; let pData = currentData.filter(r => r.name === name);
        pData.forEach(r => { let h = parseFloat(r.calc_hours); if(!isNaN(h)) totalHours += h; if (r.input_status === 'ä¼‘') cnt.rest++; else if (r.input_status === 'ä¾‹') cnt.reg++; else if (r.input_status === 'åœ‹') cnt.nat++; });
        let msg = ""; if (monthlyTargets.hrs > 0 && totalHours > monthlyTargets.hrs) msg += `â€¢ æ‡‰æœ‰ ${totalHours.toFixed(1)} > ${monthlyTargets.hrs}<br>`; if (monthlyTargets.rest > 0 && cnt.rest > monthlyTargets.rest) msg += `â€¢ ä¼‘æ¯æ—¥ ${cnt.rest} > ${monthlyTargets.rest}<br>`; if (monthlyTargets.reg > 0 && cnt.reg > monthlyTargets.reg) msg += `â€¢ ä¾‹å‡æ—¥ ${cnt.reg} > ${monthlyTargets.reg}<br>`; if (monthlyTargets.nat > 0 && cnt.nat > monthlyTargets.nat) msg += `â€¢ åœ‹å®šå‡æ—¥ ${cnt.nat} > ${monthlyTargets.nat}<br>`;
        if (msg !== "") Swal.fire({ title: 'âš ï¸ ç›®æ¨™è¶…æ¨™æé†’', html: `äººå“¡ï¼š${name}<br>${msg}`, icon: 'warning', toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
      }
      function validateAll() {
        const errors = document.querySelectorAll('.row-error'); const btn = document.getElementById('btnSave');
        btn.disabled = (errors.length > 0); btn.classList.toggle('btn-success', errors.length === 0); btn.classList.toggle('btn-secondary', errors.length > 0);
      }
      function saveData(force) {
        const rows = document.querySelectorAll('#staffTable tr'); let inputData = []; let incomplete = false;
        rows.forEach(tr => {
          const idx = parseInt(tr.getAttribute('data-index')); const s = tr.querySelector('.status-select').value; const verifyName = tr.getAttribute('data-name'); const verifyDate = tr.getAttribute('data-date');
          if (s === 'ä¸Šç­') {
            const start = tr.querySelector('.start-select').value; const end = tr.querySelector('.end-select').value; const rest = tr.querySelector('.rest-select').value;
            if (!start || !end || rest === "") { incomplete = true; tr.classList.add('row-error'); }
            inputData.push({ rowIndex: idx, verifyName: verifyName, verifyDate: verifyDate, d: s, e: start, f: end, g: rest });
          } else { inputData.push({ rowIndex: idx, verifyName: verifyName, verifyDate: verifyDate, d: s, e: "", f: "", g: "" }); }
        });
        if (incomplete) { Swal.fire('éŒ¯èª¤', 'ä¸Šç­éœ€å¡«å¯«å®Œæ•´æ™‚é–“', 'warning'); return; }
        showLoading(true, "å„²å­˜ä¸­...");
        callApi('saveStoreData', { store: currentStore, inputData: inputData, forceSave: forceSave })
          .then(res => {
             showLoading(false); 
             if (res.status === 'SUCCESS') { Swal.fire({ icon: 'success', title: 'âœ… å„²å­˜æˆåŠŸ', text: 'ç­è¡¨å·²æ›´æ–°å®Œæˆ', confirmButtonText: 'ç¢ºèª', allowOutsideClick: false }).then((result) => { if (result.isConfirmed) loadData(); }); } 
             else if (res.status === 'PARTIAL' || res.status === 'FAILED') { Swal.fire({ icon: 'warning', title: 'âš ï¸ éƒ¨åˆ†/å…¨éƒ¨å„²å­˜å¤±æ•—', html: res.message, confirmButtonText: 'ç¢ºèª' }).then(() => loadData()); } 
             else { Swal.fire('ç³»çµ±è¨Šæ¯', res.message || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤', 'error').then(() => loadData()); }
          })
          .catch(err => { showLoading(false); alert("å„²å­˜éŒ¯èª¤: " + err.message); });
      }
      function showMonthlyStats() {
         if (!currentData.length) return;
         document.getElementById('statsTarget').innerText = `æœ¬æœˆç›®æ¨™ï¼šæ‡‰æœ‰ ${monthlyTargets.hrs} å°æ™‚ | ä¼‘ ${monthlyTargets.rest} | ä¾‹ ${monthlyTargets.reg} | åœ‹ ${monthlyTargets.nat}`;
         let stats = {}; currentData.forEach(r => { if (!stats[r.name]) stats[r.name] = { type: r.salaryType, hrs:0, rest:0, reg:0, nat:0, empty:0 }; let s = r.input_status; if (s === 'ä¼‘') stats[r.name].rest++; else if (s === 'ä¾‹') stats[r.name].reg++; else if (s === 'åœ‹') stats[r.name].nat++; else if (s === 'ç©ºç­') stats[r.name].empty++; let h = parseFloat(r.calc_hours); if(!isNaN(h)) stats[r.name].hrs += h; });
         const tm = document.getElementById('statsTableMonthly'); tm.innerHTML = ''; const th = document.getElementById('statsTableHourly'); th.innerHTML = '';
         for (let n in stats) { let d = stats[n]; if (d.type.includes("æœˆè–ª")) tm.innerHTML += `<tr><td class="fw-bold">${n}</td><td>${d.hrs.toFixed(1)} (${formatDiff(d.hrs - monthlyTargets.hrs)})</td><td>${d.rest} (${formatDiff(d.rest - monthlyTargets.rest)})</td><td>${d.reg} (${formatDiff(d.reg - monthlyTargets.reg)})</td><td>${d.nat} (${formatDiff(d.nat - monthlyTargets.nat)})</td><td>${d.empty}</td></tr>`; else th.innerHTML += `<tr><td class="fw-bold">${n}</td><td>${d.hrs.toFixed(1)}</td></tr>`; }
         new bootstrap.Modal(document.getElementById('statsModal')).show();
      }
      function showIndividualStatus() {
         const select = document.getElementById('indivSelect'); select.innerHTML = ''; [...new Set(currentData.map(r=>r.name))].forEach(n => select.innerHTML+=`<option>${n}</option>`); renderIndividualTable(); new bootstrap.Modal(document.getElementById('indivModal')).show();
      }
      // ==========================================
      // è«‹æ›¿æ› renderIndividualTable å‡½å¼ (æ‰¾å›ç´…å­—é‚è¼¯)
      // ==========================================
      function renderIndividualTable() {
         const name = document.getElementById('indivSelect').value;
         const tbody = document.getElementById('indivTableBody'); 
         tbody.innerHTML = '';
         const statsDiv = document.getElementById('indivStats');
         
         const pData = currentData.filter(r => r.name === name).sort((a,b)=>a.date.localeCompare(b.date));
         
         // â˜… åˆ¤æ–·æ˜¯å¦ç‚ºæ™‚è–ªäººå“¡ (é€™æ˜¯æ±ºå®šé¡¯ç¤ºç´…å­—èˆ‡å¦çš„é—œéµ)
         const isHourly = (pData.length > 0 && pData[0].salaryType && pData[0].salaryType.includes("æ™‚è–ª"));

         let hrs=0, rest=0, reg=0, nat=0, totalOvertime=0;

         pData.forEach(r => {
            let h = parseFloat(r.calc_hours); 
            if(!isNaN(h)) hrs += h;
            
            if (r.input_status === 'ä¼‘') rest++;
            else if (r.input_status === 'ä¾‹') reg++;
            else if (r.input_status === 'åœ‹') nat++;
            
            let otHrs = parseFloat(r.sys_overtimeHrs);
            if (!isNaN(otHrs)) totalOvertime += otHrs;
         });

         let otDisplay = document.getElementById("totalOvertimeDisplay");
         if (otDisplay) {
             otDisplay.innerText = totalOvertime > 0 ? "å·²ç”³è«‹åŠ ç­ç¸½æ™‚æ•¸: " + totalOvertime.toFixed(1) : "";
         }

         // â˜… ç”¢ç”Ÿé€£çµ
         let encodedName = encodeNameHex(name);
         let currentBaseUrl = window.location.href.split('?')[0]; 
         let personalLink = `${currentBaseUrl}?mode=personal&u=${encodedName}`;

         // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ­£ï¼šé‚„åŸã€Œæœˆè–ªåˆ¶é¡¯ç¤ºç´…å­—å·®é¡ (formatDiff)ã€çš„é‚è¼¯ â˜…â˜…â˜…
         let statText = "";
         if (isHourly) {
             // æ™‚è–ªåˆ¶ï¼šåªé¡¯ç¤ºç´¯è¨ˆ
             statText = `<strong>æ‡‰æœ‰ï¼š</strong>${hrs.toFixed(1)} | <strong>ä¼‘ï¼š</strong>${rest} | <strong>ä¾‹ï¼š</strong>${reg} | <strong>åœ‹ï¼š</strong>${nat}`;
         } else {
             // æœˆè–ªåˆ¶ï¼šé¡¯ç¤ºå·®é¡ (ç´…å­—/ç¶ å­—)
             // æ³¨æ„ï¼šé€™è£¡ä¾è³´ global è®Šæ•¸ monthlyTargets
             statText = `
                <strong>æ‡‰æœ‰ï¼š</strong>${hrs.toFixed(1)} (${formatDiff(hrs - monthlyTargets.hrs)}) | 
                <strong>ä¼‘ï¼š</strong>${rest} (${formatDiff(rest - monthlyTargets.rest)}) | 
                <strong>ä¾‹ï¼š</strong>${reg} (${formatDiff(reg - monthlyTargets.reg)}) | 
                <strong>åœ‹ï¼š</strong>${nat} (${formatDiff(nat - monthlyTargets.nat)})
             `;
         }

         statsDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center w-100">
               <div>${statText}</div>
               <button class="btn btn-sm btn-outline-primary fw-bold" onclick="copyToClipboard('${personalLink}')">ğŸ“‹ è¤‡è£½å€‹äººé€£çµ</button>
            </div>
         `;

         pData.forEach(r => {
            let planTimeStr = (r.input_start && String(r.input_start).trim() !== "") ? `${r.input_start}~${r.input_end}` : "";
            tbody.innerHTML += `
              <tr>
                <td>${r.date}</td>
                <td class="fw-bold text-primary">${r.input_status}</td>
                <td style="color: #0d6efd; font-weight: bold;">${planTimeStr}</td>
                <td>${r.calc_hours}</td>
                <td>${r.sys_status}</td>
                <td>${r.sys_clockIn}</td>
                <td>${r.sys_clockOut}</td>
                <td>${r.sys_leave}</td>
                <td>${r.sys_leaveType}</td>
                <td>${r.sys_overtime}</td>
                <td>${r.sys_overtimeHrs}</td>
                <td>${r.sys_abnormal}</td>
                <td>${r.log}</td>
              </tr>`;
         });
      }
      function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => { Swal.fire({ title: 'å·²è¤‡è£½é€£çµ', text: 'è«‹å‚³é€çµ¦è©²å“¡å·¥', icon: 'success', timer: 1500, showConfirmButton: false }); }); }
      function encodeNameHex(str) { const encoder = new TextEncoder(); const view = encoder.encode(str); let hex = ""; for (let i = 0; i < view.length; i++) { let h = view[i].toString(16); hex += (h.length < 2 ? "0" : "") + h; } return hex.toUpperCase(); }
      function formatNumber(v) { return v; } 
      function showLoading(s,t) { document.getElementById('loadingOverlay').style.display = s?'flex':'none'; if(t)document.getElementById('loadingText').innerText=t;}
      function errorHandler(e) { showLoading(false); Swal.fire('éŒ¯èª¤', e.message||e, 'error'); }
      function generateTimeOptions() { let o='<option value="">è«‹é¸æ“‡</option>'; for(let h=0;h<24;h++){ let s=('0'+h).slice(-2); o+=`<option value="${s}:00">${s}:00</option><option value="${s}:30">${s}:30</option>`; } return o; }
      function generateRestOptions() { let o='<option value="">è«‹é¸æ“‡</option>'; for(let i=0; i<=8; i++){ let v = (i * 0.5).toFixed(1); o += `<option value="${v}">${v}</option>`; } return o; }
      function createTimeSelect(v,c) { return `<select class="form-select time-select ${c}" onchange="handleRowChange(this)">${timeOptions.replace(`value="${v}"`,`value="${v}" selected`)}</select>`; }
      function createRestSelect(v) { return `<select class="form-select rest-select" onchange="handleRowChange(this)">${restOptions.replace(`value="${v}"`,`value="${v}" selected`)}</select>`; }
      function timeToFloat(t) { let p=t.split(':'); return parseInt(p[0])+(parseInt(p[1])/60); }
      function formatTime(v) { if(!v) return ""; if(v instanceof Date) return ("0"+v.getHours()).slice(-2) + ":" + ("0"+v.getMinutes()).slice(-2); let s = String(v).trim(); if (s.includes("T")) return s.substr(11, 5); return s; }
      function formatDiff(val) { let n = parseFloat(val).toFixed(1); if (Math.abs(val) < 0.1) return `<span class="text-muted">0</span>`; if (val < 0) return `<span class="diff-neg">${n}</span>`; return `<span class="diff-pos">+${n}</span>`; }
      async function handleChangePassword() {
        if (!currentStore) return;
        const { value: formValues } = await Swal.fire({ title: 'ğŸ”‘ è®Šæ›´ç™»å…¥å¯†ç¢¼', html: '<div class="text-start mb-2"><label class="fw-bold">ç›®å‰èˆŠå¯†ç¢¼</label><input id="swal-input1" class="form-control" type="password"></div><div class="text-start mb-2"><label class="fw-bold text-primary">è¨­å®šæ–°å¯†ç¢¼</label><input id="swal-input2" class="form-control" type="password"></div><div class="text-start"><label class="fw-bold text-primary">ç¢ºèªæ–°å¯†ç¢¼</label><input id="swal-input3" class="form-control" type="password"></div>', focusConfirm: false, showCancelButton: true, confirmButtonText: 'ç¢ºèªè®Šæ›´', cancelButtonText: 'å–æ¶ˆ', preConfirm: () => { const oldPwd = document.getElementById('swal-input1').value; const newPwd = document.getElementById('swal-input2').value; const cfmPwd = document.getElementById('swal-input3').value; if (!oldPwd || !newPwd || !cfmPwd) { Swal.showValidationMessage('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½'); return false; } if (newPwd !== cfmPwd) { Swal.showValidationMessage('å…©æ¬¡æ–°å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´'); return false; } return { oldPwd: oldPwd, newPwd: newPwd }; } });
        if (formValues) { showLoading(true, "æ›´æ–°å¯†ç¢¼ä¸­..."); callApi('changePassword', { store: currentStore, oldPwd: formValues.oldPwd, newPwd: formValues.newPwd }).then(res => { showLoading(false); if (res.success) { Swal.fire({ icon: 'success', title: 'æˆåŠŸ', text: res.message }).then(() => logout()); } else { Swal.fire('è®Šæ›´å¤±æ•—', res.message, 'error'); } }).catch(err => errorHandler(err)); }
      }
    </script>
  </body>
</html>
